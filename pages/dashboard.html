<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insight360TN — Professional NFHS Dashboard</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Material icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body,#app{height:100vh;margin:0;background:var(--bg);overflow:hidden}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:18px;padding:18px;height:100vh;align-items:start;box-sizing:border-box}
    .left-column{display:flex;flex-direction:column;gap:12px}

    /* Sidebar */
    .sidebar{background:linear-gradient(180deg,#ffffff, #fbfdff);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(22,38,99,0.06);height:calc(90vh - 36px)}
    .sidebar-header{display:flex;align-items:center;gap:12px}
    .sidebar-header h3{margin:0;font-size:15px}
    .survey-toggle{display:flex;gap:8px;margin-top:12px}
    .toggle-btn{flex:1;padding:6px;border-radius:8px;border:1px solid #e6eefb;background:#fff;cursor:pointer;font-size:13px}
    .toggle-btn.active{background:var(--accent);color:#fff;border-color:transparent}

    #categoryTree{margin-top:14px;max-height:calc(100vh - 160px);overflow:auto;padding-right:6px;font-size:14px}
    .category{border-radius:8px;padding:6px;margin-bottom:6px;transition:all 0.2s ease}
    .category-header{display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;color:#0f172a;font-size:13px}
    .category.expanded .material-icons{transform:rotate(90deg)}
    .category .material-icons{transition:transform 0.2s ease;font-size:17px}
    .indicators{margin-top:6px;display:grid;grid-template-columns:1fr;gap:4px;max-height:0;overflow:hidden;transition:max-height 0.3s ease}
    .category.expanded .indicators{max-height:500px}
    .indicator{padding:6px 8px;border-radius:6px;background:rgba(15,23,42,0.03);cursor:pointer;font-size:12px;line-height:1.3}
    .indicator:hover{background:rgba(37,99,235,0.06)}

    /* Main */
    .main{display:flex;flex-direction:column;gap:12px}
    .header{display:flex;justify-content:space-between;align-items:center}
    .title{display:flex;flex-direction:column}
    .title h1{margin:0;font-size:20px}
    .title p{margin:0;color:var(--muted);font-size:13px}

    .map-card{height:75vh;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(22,38,99,0.06);background:var(--card);padding:0;margin:0}
    .map-legend{margin-top:1px;padding:12px 16px;background:var(--card);border-radius:8px;box-shadow:0 2px 8px rgba(2,6,23,0.04);border-left:4px solid var(--accent)}
    #map{height:100%;width:100%}

    /* Right sidebar */
    .right{display:flex;flex-direction:column;gap:10px}
    .kpi-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .card{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 4px 14px rgba(2,6,23,0.03)}
    .card h4{margin:0;font-size:12px}
    .card .value{font-size:18px;font-weight:700;margin-top:4px}

    .legend{padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.9), rgba(255,255,255,0.75));box-shadow:0 6px 24px rgba(15,23,42,0.04)}

    /* small responsive */
    @media (max-width:1100px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;padding:10px}.sidebar{order:3}.right{order:2}.main{order:1}}

    /* tooltip */
    .info-box{position:absolute;z-index:9999;pointer-events:none;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.08);font-size:13px}
  </style>
</head>

<body>
  <div id="app" class="app">

    <!-- LEFT: controls -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="material-icons" style="color:var(--accent)">dashboard</span>
        <div>
          <h3>NFHS Indicators</h3>
          <div style="font-size:12px;color:var(--muted)">Tamil Nadu — Insight360TN</div>
        </div>
      </div>

      <div class="survey-toggle" style="margin-top:12px">
        <button id="nfhs4Btn" class="toggle-btn active" onclick="toggleSurvey('nfhs4')">NFHS-4</button>
        <button id="nfhs5Btn" class="toggle-btn" onclick="toggleSurvey('nfhs5')">NFHS-5</button>
      </div>

      <div style="margin-top:12px">
        <input id="searchIndicator" placeholder="Search indicators..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb" />
      </div>

      <div id="categoryTree"></div>
    </aside>

    <!-- MAIN: map + header -->
    <main class="main">
      <div class="header">
        <div class="title">
          <div style="display:flex;align-items:center;gap:14px">
            <div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0b62a8);display:flex;align-items:center;justify-content:center;font-weight:700">
              <span class="material-icons" style="font-size:26px;color:white">map</span>
            </div>
            <div>
              <h1 style="margin:0;font-size:20px">Insight360TN</h1>
              <p style="margin:0;font-size:12px;color:var(--muted)">NFHS + GIS — Tamil Nadu Health Dashboard • Powered by Gemini AI</p>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Active survey:</div>
          <strong id="activeSurveyLabel">NFHS-4</strong>
        </div>
      </div>

      <div class="map-card" style="position:relative">
        <div id="map"></div>
        <div style="position:absolute;top:12px;left:12px;z-index:1000;display:flex;gap:6px">
          <div style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:white;padding:6px 10px;border-radius:8px;cursor:pointer;box-shadow:0 4px 12px rgba(30,64,175,0.4);transition:all 0.2s ease;display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600" onclick="showFullRankings()" title="View complete rankings">
            <span class="material-icons" style="font-size:16px">table_view</span>
            <span>Table</span>
          </div>
          <div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:6px 10px;border-radius:8px;cursor:pointer;box-shadow:0 4px 12px rgba(5,150,105,0.4);transition:all 0.2s ease;display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600" onclick="showBarChartPopup()" title="View bar chart">
            <span class="material-icons" style="font-size:16px">bar_chart</span>
            <span>Chart</span>
          </div>
        </div>
      </div>
      
      <div class="map-legend">
        <div id="legend"></div>
      </div>
    </main>

    <!-- RIGHT: KPIs & charts -->
    <aside class="right">
      <div class="card">
        <h4 id="indicatorTitle">Select an indicator</h4>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div style="font-size:12px;color:var(--muted)">Survey:</div>
          <div id="indicatorSurvey" style="font-weight:600">-</div>
        </div>
        <div id="kpiRow" style="margin-top:12px" class="kpi-cards"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h4>District Rankings</h4>
        </div>
        <div id="districtRankings"></div>
      </div>

      <div class="card" id="interpretationCard" style="display: none;">
        <div style="margin-bottom: 16px;">
          <button id="generateInterpretationBtn" style="background: #4285f4; color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); width: 100%; justify-content: center;" onclick="generateDashboardInterpretation()">
            <span class="material-icons" style="font-size: 16px;">psychology</span>
            AI Interpretation
          </button>
        </div>
        <div id="interpretationContent" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; color: #4285f4; background: rgba(66, 133, 244, 0.08); padding: 4px 10px; border-radius: 12px;">
              <span class="material-icons" style="font-size: 12px;">auto_awesome</span>
              AI Analysis
            </div>
            <button onclick="generateDashboardInterpretation()" style="background: #f8f9fa; color: #4285f4; border: 1px solid #e8eaed; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease;">
              <span class="material-icons" style="font-size: 12px;">auto_awesome</span>
              Generate - Click to Read
            </button>
          </div>

        </div>
        <div id="loadingInterpretation" style="display: none; padding: 16px; background: #f8fafc; border-radius: 8px; font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 12px;">
          <div style="width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <span>Generating interpretation...</span>
        </div>
      </div>

    </aside>
  </div>

  <div id="info" class="info-box" style="display:none"></div>

  <!-- Floating Hamburger Menu -->
  <div id="hamburgerMenu" style="position:fixed;top:20px;right:20px;z-index:10000">
    <div id="menuButton" style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:12px;border-radius:12px;cursor:pointer;box-shadow:0 8px 24px rgba(37,99,235,0.4);transition:all 0.3s ease" onclick="toggleMenu()" title="Menu">
      <span class="material-icons" style="font-size:20px">menu</span>
    </div>
    <div id="menuItems" style="position:absolute;top:60px;right:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.3);padding:8px;display:none;flex-direction:column;gap:6px;min-width:180px">
      <div style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.location.href='../index.html'">
        <span class="material-icons" style="font-size:16px">home</span>
        <span>Home</span>
      </div>
      <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.location.href='district-analysis.html'">
        <span class="material-icons" style="font-size:16px">analytics</span>
        <span>District Analysis</span>
      </div>
      <div style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.location.href='advanced-analytics.html'">
        <span class="material-icons" style="font-size:16px">scatter_plot</span>
        <span>Advanced Analytics</span>
      </div>
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.open('https://github.com/drsivambbs/Insight360TN','_blank')">
        <span class="material-icons" style="font-size:16px">code</span>
        <span>GitHub</span>
      </div>
      <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="showInfoPopup()">
        <span class="material-icons" style="font-size:16px">info</span>
        <span>About</span>
      </div>
    </div>
  </div>

  <!-- Dashboard Interpretation Modal -->
  <div id="dashboardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; backdrop-filter: blur(4px);" onclick="closeDashboardModal(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2);" onclick="event.stopPropagation()">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e8eaed;">
        <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px; margin: 0;">
          <span class="material-icons" style="font-size: 20px; color: #4285f4;">psychology</span>
          AI Interpretation
        </h3>
        <button onclick="closeDashboardModal()" style="background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s ease;">&times;</button>
      </div>
      <div>
        <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: #4285f4; background: rgba(66, 133, 244, 0.08); padding: 6px 12px; border-radius: 16px; width: fit-content; margin-bottom: 16px;">
          <span class="material-icons" style="font-size: 14px;">auto_awesome</span>
          Generated by Scooby AI
        </div>
        <div id="analysisContext" style="background: #f8f9fa; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #4285f4;">
          <div style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">Analysis Context</div>
          <div id="contextDetails" style="font-size: 12px; color: #5f6368;"></div>
        </div>
        <div id="modalInterpretationText" style="font-size: 14px; line-height: 1.6;"></div>
        <div style="margin-top: 20px; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #6c757d;">
            <span class="material-icons" style="font-size: 16px; color: #6c757d;">info</span>
            <span><strong>Disclaimer:</strong> AI-generated interpretation for reference only. Verify findings with official health data sources.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../js/chatbot-widget.js"></script>
  <script>
    // --- state ---
    let categoriesData, nfhsData, geoJsonData, map, activeSurvey = 'nfhs4', currentLayer, currentIndicator, districtValues = {};
    const colorScale = [ '#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#3182bd','#08519c' ];

    // Load data directly
    Promise.all([
      fetch('../dashboard_files/nfhs_indicator_categories.json').then(r=>r.json()),
      fetch('../dashboard_files/master_nfhs_data.json').then(r=>r.json()),
      fetch('../dashboard_files/tn_district.geojson').then(r=>r.json())
    ]).then(([categories, nfhs, geojson]) => {
      categoriesData = categories;
      nfhsData = nfhs;
      geoJsonData = geojson;
      initMap();
      renderCategories();
    }).catch(err=>{
      console.error('Failed to load data', err);
    });

    function initMap(){
      map = L.map('map', {zoomControl:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:''}).addTo(map);
      L.control.zoom({position:'topright'}).addTo(map);

      // Add home button
      const homeControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function(map) {
          const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          container.style.backgroundColor = 'white';
          container.style.width = '30px';
          container.style.height = '30px';
          container.style.cursor = 'pointer';
          container.style.display = 'flex';
          container.style.alignItems = 'center';
          container.style.justifyContent = 'center';
          container.innerHTML = '<span class="material-icons" style="font-size:18px;color:#666">home</span>';
          container.onclick = function(){
            if(currentLayer) map.fitBounds(currentLayer.getBounds(), {padding:[5,5]});
          };
          return container;
        }
      });
      map.addControl(new homeControl());

      // Add GeoJSON layer with default styling
      if(geoJsonData){
        currentLayer = L.geoJSON(geoJsonData, {style: defaultStyle}).addTo(map);
        map.fitBounds(currentLayer.getBounds(), {padding:[5,5]});
        setTimeout(() => map.setZoom(map.getZoom()), 100);
      }

      // Info control
      map.on('mousemove', function(e){ let info = document.getElementById('info'); info.style.left = (e.originalEvent.clientX+12)+'px'; info.style.top = (e.originalEvent.clientY+12)+'px'; });
    }

    function defaultStyle(){ return {color:'#000000',weight:0.8,fillColor:'#efefef',fillOpacity:0} }

    // --- categories UI ---
    function renderCategories(){
      console.log('renderCategories called with:', { activeSurvey, categoriesData, nfhsData });
      const tree = document.getElementById('categoryTree');
      const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
      const firstDistrict = Object.values(nfhsData.districts)[0];
      console.log('First district data:', firstDistrict);
      const availableKeys = new Set(Object.keys(firstDistrict[surveyKey] || {}));
      console.log('Available keys for', surveyKey, ':', Array.from(availableKeys));

      tree.innerHTML = '';
      Object.entries(categoriesData.categories).forEach(([catKey, catData])=>{
        const indicators = catData.indicators.map(i => (typeof i === 'string'? i: (i.name||i))).filter(Boolean);
        const available = indicators.filter(name => availableKeys.has(name));
        console.log('Category:', catKey, 'Total indicators:', indicators.length, 'Available:', available.length);
        if(!available.length) return;

        const div = document.createElement('div'); div.className = 'category';
        const header = document.createElement('div'); header.className='category-header'; header.innerHTML = `<span class="material-icons">chevron_right</span><span>${catKey.replace(/_/g,' ')} (${available.length})</span>`;
        header.onclick = ()=> div.classList.toggle('expanded');
        div.appendChild(header);

        const inner = document.createElement('div'); inner.className='indicators';
        available.forEach(ind=>{
          const el = document.createElement('div'); el.className='indicator'; el.textContent = ind; el.onclick = ()=> selectIndicator(ind);
          inner.appendChild(el);
        });
        div.appendChild(inner);
        tree.appendChild(div);
      });
      console.log('Categories rendered. Tree innerHTML length:', tree.innerHTML.length);

      // wire search with auto-search functionality
      const search = document.getElementById('searchIndicator');
      search.oninput = ()=>{
        const q = search.value.trim().toLowerCase();
        let hasVisibleIndicators = false;
        
        // Search through all categories and indicators
        document.querySelectorAll('.category').forEach(categoryEl=>{
          const categoryHeader = categoryEl.querySelector('.category-header span:last-child').textContent.toLowerCase();
          const indicators = categoryEl.querySelectorAll('.indicator');
          let categoryHasVisible = false;
          
          // Check indicators in this category
          indicators.forEach(el=>{
            const matches = el.textContent.toLowerCase().includes(q) || categoryHeader.includes(q);
            el.style.display = matches ? 'block' : 'none';
            if(matches) {
              categoryHasVisible = true;
              hasVisibleIndicators = true;
            }
          });
          
          // Show/hide category based on matches
          categoryEl.style.display = categoryHasVisible || q === '' ? 'block' : 'none';
          
          // Auto-expand categories with matches
          if(categoryHasVisible && q !== '') {
            categoryEl.classList.add('expanded');
          } else if(q === '') {
            categoryEl.classList.remove('expanded');
          }
        });
        
        // Show "no results" message if needed
        if(!hasVisibleIndicators && q !== '') {
          if(!document.getElementById('noResults')) {
            const noResults = document.createElement('div');
            noResults.id = 'noResults';
            noResults.style.cssText = 'padding:20px;text-align:center;color:var(--muted);font-style:italic';
            noResults.textContent = 'No indicators found';
            document.getElementById('categoryTree').appendChild(noResults);
          }
        } else {
          const noResults = document.getElementById('noResults');
          if(noResults) noResults.remove();
        }
      }
    }

    function toggleSurvey(survey){ activeSurvey = survey; document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active')); document.getElementById(survey+'Btn').classList.add('active'); document.getElementById('activeSurveyLabel').textContent = survey.toUpperCase(); renderCategories(); if(currentIndicator) selectIndicator(currentIndicator); }

    // --- indicator selection and map coloring ---
    function selectIndicator(indicator){
      currentIndicator = indicator;
      document.getElementById('indicatorTitle').textContent = indicator;
      document.getElementById('indicatorSurvey').textContent = activeSurvey.toUpperCase();

      // Collapse all categories after selection
      const expandedCategories = document.querySelectorAll('.category.expanded');
      console.log('Auto-collapsing', expandedCategories.length, 'categories');
      expandedCategories.forEach(cat => cat.classList.remove('expanded'));

      // Get indicator type
      const indicatorType = getIndicatorType(indicator);

      // District mapping for newly formed districts
      const districtMapping = {
        'chengalpattu': 'kanchipuram',
        'kallakurichi': 'villupuram', 
        'mayiladuthurai': 'nagapattinam',
        'ranipet': 'vellore',
        'tenkasi': 'tirunelveli',
        'tirupathur': 'vellore'
      };

      // gather district values
      const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
      districtValues = {};
      Object.entries(nfhsData.districts).forEach(([district, data])=>{
        const v = data[surveyKey] && data[surveyKey][indicator];
        if(v!==undefined && v!==null && v!=="" ) {
          districtValues[district.toLowerCase()] = +v;
          // Map to newly formed districts
          Object.entries(districtMapping).forEach(([newDist, parentDist]) => {
            if(district.toLowerCase() === parentDist) {
              districtValues[newDist] = +v;
            }
          });
        }
      });

      // compute tertiles for 3 colors
      const vals = Object.values(districtValues).filter(v=>!isNaN(v)).sort((a,b)=>a-b);
      const tertiles = computeTertiles(vals);

      // update legend
      renderLegend(tertiles, indicatorType);

      // style geojson
      if(currentLayer) map.removeLayer(currentLayer);
      currentLayer = L.geoJSON(geoJsonData, {style: feat=>{
        const name = (feat.properties && (feat.properties.District || feat.properties.DISTRICT || feat.properties.district || feat.properties.NAME)) || '';
        const val = districtValues[name.toLowerCase()];
        return {fillColor: getColorForValue(val, tertiles, indicatorType), weight:0.8, color:'#000', fillOpacity: val===undefined?0.6:0.8}
      }, onEachFeature}).addTo(map);

      // update KPIs + chart
      updateKPIsAndChart(districtValues, indicator);
    }

    function getIndicatorType(indicator){
      for(const [catKey, catData] of Object.entries(categoriesData.categories)){
        for(const ind of catData.indicators){
          const indName = typeof ind === 'string' ? ind : ind.name;
          if(indName === indicator){
            return typeof ind === 'object' ? ind.indicator_type : 'Positive';
          }
        }
      }
      return 'Positive';
    }

    function computeTertiles(vals){
      if(vals.length < 3) return vals;
      const third = Math.floor(vals.length / 3);
      return [vals[third], vals[third * 2]];
    }

    function getColorForValue(v, tertiles, indicatorType){
      if(v===undefined || isNaN(v)) return '#cccccc';
      if(tertiles.length < 2) return '#ffeb3b';
      
      if(indicatorType === 'Positive' || indicatorType === 'Neutral'){
        if(v <= tertiles[0]) return '#f44336';
        if(v <= tertiles[1]) return '#ffeb3b';
        return '#4caf50';
      } else if(indicatorType === 'Negative'){
        if(v <= tertiles[0]) return '#4caf50';
        if(v <= tertiles[1]) return '#ffeb3b';
        return '#f44336';
      }
      return '#ffeb3b';
    }

    function onEachFeature(feature, layer){
      layer.on({ mouseover: (e)=>{
        const el = e.target; el.setStyle({weight:2,fillOpacity:1});
        const props = feature.properties||{}; const name = props.District || props.DISTRICT || props.district || props.NAME || '—';
        const value = districtValues[name.toLowerCase()] || 'No data';
        const info = document.getElementById('info'); info.style.display='block'; info.innerHTML = `<strong>${name}</strong><div style="color:var(--muted);font-size:12px">${value}</div>`;
      }, mouseout: (e)=>{ const el=e.target; try{ currentLayer.resetStyle(el); }catch(e){} document.getElementById('info').style.display='none'; }, click: (e)=>{ map.fitBounds(e.target.getBounds()); } });
    }

    // compute quantile breaks (k groups)
    function computeQuantiles(arr, k){ if(!arr.length) return []; const breaks=[]; for(let i=1;i<=k;i++){ const p = i/(k+1); const idx = p*(arr.length-1); const lo = Math.floor(idx); const hi = Math.ceil(idx); const val = lo===hi ? arr[lo] : arr[lo] + (arr[hi]-arr[lo])*(idx-lo); breaks.push(Number(val.toFixed(3))); } return breaks; }

    function renderLegend(tertiles, indicatorType){
      const container = document.getElementById('legend');
      container.innerHTML='';
      
      if(!tertiles.length){
        container.innerHTML = '<div style="color:var(--muted)">No data available</div>';
        return;
      }
      
      const list = document.createElement('div');
      list.style.display='flex';
      list.style.gap='16px';
      list.style.alignItems='center';
      
      // Add title first
      const title = document.createElement('div');
      title.style.display='flex';
      title.style.alignItems='center';
      title.style.gap='6px';
      title.innerHTML = `<span class="material-icons" style="font-size:16px;color:var(--accent)">palette</span><span style="font-size:13px;font-weight:600;color:var(--text)">Map Legend:</span>`;
      list.appendChild(title);
      
      const colors = ['#4caf50', '#ffeb3b', '#f44336', '#cccccc'];
      const labels = indicatorType === 'Positive' ? ['Best', 'Medium', 'Worst', 'No Data'] : ['Best', 'Medium', 'Worst', 'No Data'];
      
      for(let i=0; i<4; i++){
        const label = document.createElement('div');
        label.style.display='flex';
        label.style.alignItems='center';
        label.style.gap='6px';
        
        const sw = document.createElement('div');
        sw.style.width='20px';
        sw.style.height='12px';
        sw.style.borderRadius='3px';
        sw.style.background = colors[i];
        sw.style.boxShadow='inset 0 -1px rgba(0,0,0,0.1)';
        
        const text = document.createElement('div');
        text.style.fontSize='12px';
        text.style.color='var(--muted)';
        text.textContent = labels[i];
        
        label.appendChild(sw);
        label.appendChild(text);
        list.appendChild(label);
      }
      
      container.appendChild(list);
    }

    // KPI & Rankings
    function updateKPIsAndChart(districtValues, indicator){
      const entries = Object.entries(districtValues).map(([d,v])=>[d,v]).filter(([d,v])=>!isNaN(v));
      const indicatorType = getIndicatorType(indicator);
      
      // Sort based on indicator type
      if(indicatorType === 'Negative'){
        entries.sort((a,b)=>a[1]-b[1]); // Lower is better for negative indicators
      } else {
        entries.sort((a,b)=>b[1]-a[1]); // Higher is better for positive/neutral indicators
      }
      
      const top = entries.slice(0,1)[0];
      const bottom = entries.slice(-1)[0];
      const total = entries.length;
      const avg = (entries.reduce((s,[_d,v])=>s+v,0)/Math.max(1,entries.length)).toFixed(2);

      // KPI cards in 3x2 grid
      const kpiRow = document.getElementById('kpiRow'); kpiRow.innerHTML='';
      const makeCard = (title, value) => { const c = document.createElement('div'); c.className='card'; c.style.padding='8px'; c.innerHTML = `<div style="font-size:11px;color:var(--muted)">${title}</div><div class="value" style="font-size:16px">${value}</div>`; return c; };
      kpiRow.appendChild(makeCard('Districts', total));
      kpiRow.appendChild(makeCard('Average', avg));
      kpiRow.appendChild(makeCard('Best District', top? capitalizeWords(top[0]) : 'N/A'));
      kpiRow.appendChild(makeCard('Best Value', top? top[1] : 'N/A'));
      kpiRow.appendChild(makeCard('Low District', bottom? capitalizeWords(bottom[0]) : 'N/A'));
      kpiRow.appendChild(makeCard('Low Value', bottom? bottom[1] : 'N/A'));

      // District rankings
      renderDistrictRankings(entries, indicatorType);
      
      // Show interpretation card but reset content
      document.getElementById('interpretationCard').style.display = 'block';
      document.getElementById('interpretationContent').style.display = 'none';
      document.getElementById('loadingInterpretation').style.display = 'none';
    }

    function renderDistrictRankings(entries, indicatorType){
      const container = document.getElementById('districtRankings');
      if(!entries.length){
        container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">No data available</div>';
        fullRankingsData = [];
        return;
      }

      // Store full data for popup
      fullRankingsData = [...entries];
      
      const top3 = entries.slice(0,3);
      const bottom3 = entries.slice(-3).reverse();
      
      container.innerHTML = `
        <table style="width:100%;font-size:14px;border-collapse:collapse">
          <thead>
            <tr style="background:#f8f9fa;border-bottom:1px solid #e9ecef">
              <th style="text-align:left;padding:6px 8px;font-weight:600;color:var(--muted)">Rank</th>
              <th style="text-align:left;padding:6px 8px;font-weight:600;color:var(--muted)">District</th>
              <th style="text-align:right;padding:6px 8px;font-weight:600;color:var(--muted)">Value</th>
            </tr>
          </thead>
          <tbody>
            ${top3.map((entry, i) => `
              <tr style="border-bottom:1px solid #f1f3f4">
                <td style="padding:6px 8px">
                  <span style="background:#4caf50;color:white;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600">${i+1}</span>
                </td>
                <td style="padding:6px 8px;font-weight:500">${capitalizeWords(entry[0])}</td>
                <td style="padding:6px 8px;text-align:right;font-weight:600;color:#4caf50">${entry[1]}</td>
              </tr>
            `).join('')}
            <tr><td colspan="3" style="padding:4px;background:#f8f9fa"></td></tr>
            ${bottom3.map((entry, i) => `
              <tr style="border-bottom:1px solid #f1f3f4">
                <td style="padding:6px 8px">
                  <span style="background:#f44336;color:white;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600">${entries.length - 2 + i}</span>
                </td>
                <td style="padding:6px 8px;font-weight:500">${capitalizeWords(entry[0])}</td>
                <td style="padding:6px 8px;text-align:right;font-weight:600;color:#f44336">${entry[1]}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function capitalizeWords(s){ return s.split(/[_\s]+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(239,68,68,0.3);z-index:10001;font-size:14px;font-weight:500;display:flex;align-items:center;gap:8px;animation:slideIn 0.3s ease';
      notification.innerHTML = `<span class="material-icons" style="font-size:18px">info</span>${message}`;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    let menuOpen = false;

    function toggleMenu() {
      const menuItems = document.getElementById('menuItems');
      const menuButton = document.getElementById('menuButton');
      
      if (menuOpen) {
        menuItems.style.display = 'none';
        menuButton.style.transform = 'rotate(0deg)';
        menuOpen = false;
      } else {
        menuItems.style.display = 'flex';
        menuButton.style.transform = 'rotate(90deg)';
        menuOpen = true;
      }
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('hamburgerMenu');
      if (!menu.contains(e.target) && menuOpen) {
        toggleMenu();
      }
    });

    function showInfoPopup() {
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
      
      const modal = document.createElement('div');
      modal.style.cssText = 'background:white;border-radius:16px;padding:24px;max-width:500px;box-shadow:0 25px 50px rgba(0,0,0,0.25)';
      
      modal.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0;color:#1e293b;font-weight:700">About Insight360TN</h3>
          <div style="background:#ef4444;color:white;padding:6px;border-radius:6px;cursor:pointer" onclick="this.parentElement.parentElement.parentElement.remove()">
            <span class="material-icons" style="font-size:16px">close</span>
          </div>
        </div>
        <p style="color:#64748b;margin:0 0 16px;line-height:1.5">Professional NFHS dashboard for Tamil Nadu with interactive mapping, district rankings, and comprehensive health indicators analysis.</p>
        <div style="display:flex;gap:8px">
          <button style="background:#2563eb;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer" onclick="window.open('https://github.com/drsivambbs/Insight360TN','_blank')">View Source</button>
          <button style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer" onclick="window.location.href='index.html'">Back to Home</button>
        </div>
      `;
      
      popup.appendChild(modal);
      document.body.appendChild(popup);
      
      popup.onclick = (e) => { if(e.target === popup) popup.remove(); };
    }

    // Full rankings popup
    let fullRankingsData = [];
    let currentRankingsPopup = null;
    let currentBarChartPopup = null;
    let districtChart = null;
    
    function closeRankingsPopup(){
      if(currentRankingsPopup) {
        currentRankingsPopup.remove();
        currentRankingsPopup = null;
      }
    }
    
    function showFullRankings(){
      if(!currentIndicator) {
        showNotification('Please select an indicator first');
        return;
      }
      if(!fullRankingsData.length) return;
      
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
      
      const modal = document.createElement('div');
      modal.style.cssText = 'background:white;border-radius:16px;padding:24px;width:80%;max-width:1200px;max-height:85vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.2)';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #f1f5f9;padding-bottom:16px';
      header.innerHTML = `
        <div>
          <h3 style="margin:0;color:#1e293b;font-weight:700;font-size:18px">Complete District Rankings</h3>
          <div style="margin:8px 0 0;display:flex;flex-direction:column;gap:4px">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="background:linear-gradient(135deg,var(--accent),#1e40af);color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase">${activeSurvey.replace('nfhs', 'NFHS-')}</span>
              <span style="color:#374151;font-weight:600;font-size:14px">${currentIndicator || 'All Districts'}</span>
            </div>
            <div style="color:#64748b;font-size:12px;font-style:italic">Tamil Nadu • ${Object.keys(districtValues).length} Districts</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:8px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(16,185,129,0.3);transition:all 0.2s ease" onclick="exportRankings()" title="Export rankings">
            <span class="material-icons" style="font-size:18px">download</span>
          </div>
          <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:8px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(239,68,68,0.3);transition:all 0.2s ease" onclick="closeRankingsPopup()" title="Close">
            <span class="material-icons" style="font-size:18px">close</span>
          </div>
        </div>
      `;
      
      const content = document.createElement('div');
      content.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;max-height:60vh;overflow-y:auto';
      
      // Divide into three color-coded groups
      const total = fullRankingsData.length;
      const third = Math.ceil(total / 3);
      const greenGroup = fullRankingsData.slice(0, third);
      const yellowGroup = fullRankingsData.slice(third, third * 2);
      const redGroup = fullRankingsData.slice(third * 2);
      
      const groups = [
        { data: greenGroup, color: '#2e7d32', bgColor: '#e8f5e8', title: 'Best Performers', icon: 'trending_up' },
        { data: yellowGroup, color: '#f57c00', bgColor: '#fff8e1', title: 'Average Performers', icon: 'trending_flat' },
        { data: redGroup, color: '#c62828', bgColor: '#ffebee', title: 'Needs Attention', icon: 'trending_down' }
      ];
      
      groups.forEach(group => {
        const col = document.createElement('div');
        col.innerHTML = `
          <div style="background:${group.bgColor};padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid ${group.color}">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <span class="material-icons" style="color:${group.color};font-size:20px">${group.icon}</span>
              <span style="font-weight:600;color:${group.color};font-size:14px">${group.title}</span>
            </div>
          </div>
          <table style="width:100%;font-size:13px;border-collapse:collapse">
            <thead>
              <tr style="background:${group.bgColor};border-bottom:2px solid ${group.color}">
                <th style="text-align:left;padding:8px;font-weight:600;color:${group.color}">Rank</th>
                <th style="text-align:left;padding:8px;font-weight:600;color:${group.color}">District</th>
                <th style="text-align:right;padding:8px;font-weight:600;color:${group.color}">Value</th>
              </tr>
            </thead>
            <tbody>
              ${group.data.map((entry, i) => {
                const globalRank = fullRankingsData.indexOf(entry) + 1;
                return `
                  <tr style="border-bottom:1px solid #f1f3f4;transition:background 0.2s ease" onmouseover="this.style.background='${group.bgColor}'" onmouseout="this.style.background='transparent'">
                    <td style="padding:8px">
                      <span style="background:${group.color};color:white;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600">${globalRank}</span>
                    </td>
                    <td style="padding:8px;font-weight:500;color:#374151">${capitalizeWords(entry[0])}</td>
                    <td style="padding:8px;text-align:right;font-weight:600;color:${group.color}">${entry[1]}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        content.appendChild(col);
      });
      
      modal.appendChild(header);
      modal.appendChild(content);
      popup.appendChild(modal);
      document.body.appendChild(popup);
      
      // Store reference for proper closing
      currentRankingsPopup = popup;
      
      // Close on background click
      popup.onclick = (e) => { if(e.target === popup) closeRankingsPopup(); };
    }
    
    function exportRankings(){
      if(!fullRankingsData.length) return;
      
      let csv = 'Rank,District,Value\n';
      fullRankingsData.forEach((entry, i) => {
        csv += `${i+1},"${capitalizeWords(entry[0])}",${entry[1]}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `district-rankings-${currentIndicator?.replace(/[^a-zA-Z0-9]/g, '-') || 'data'}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function showBarChartPopup(){
      if(!currentIndicator) {
        showNotification('Please select an indicator first');
        return;
      }
      if(!fullRankingsData.length) return;
      
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
      
      const modal = document.createElement('div');
      modal.style.cssText = 'background:white;border-radius:16px;padding:24px;width:80%;max-width:1200px;max-height:85vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.2)';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #f1f5f9;padding-bottom:16px';
      header.innerHTML = `
        <div>
          <h3 style="margin:0;color:#1e293b;font-weight:700;font-size:18px">District Performance Chart</h3>
          <div style="margin:8px 0 0;display:flex;flex-direction:column;gap:4px">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="background:linear-gradient(135deg,var(--accent),#1e40af);color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase">${activeSurvey.replace('nfhs', 'NFHS-')}</span>
              <span style="color:#374151;font-weight:600;font-size:14px">${currentIndicator || 'All Districts'}</span>
            </div>
            <div style="color:#64748b;font-size:12px;font-style:italic">Tamil Nadu • ${Object.keys(districtValues).length} Districts</div>
          </div>
        </div>
        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:8px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(239,68,68,0.3);transition:all 0.2s ease" onclick="closeBarChartPopup()" title="Close">
          <span class="material-icons" style="font-size:18px">close</span>
        </div>
      `;
      
      const content = document.createElement('div');
      content.style.cssText = 'height:500px;position:relative';
      
      const canvas = document.createElement('canvas');
      canvas.id = 'districtBarChart';
      content.appendChild(canvas);
      
      modal.appendChild(header);
      modal.appendChild(content);
      popup.appendChild(modal);
      document.body.appendChild(popup);
      
      // Store reference for proper closing
      currentBarChartPopup = popup;
      
      // Close on background click
      popup.onclick = (e) => { if(e.target === popup) closeBarChartPopup(); };
      
      // Create chart after DOM is ready
      setTimeout(() => createBarChart(), 100);
    }

    function closeBarChartPopup(){
      if(currentBarChartPopup) {
        currentBarChartPopup.remove();
        currentBarChartPopup = null;
      }
      if(districtChart) {
        districtChart.destroy();
        districtChart = null;
      }
    }

    function createBarChart(){
      const canvas = document.getElementById('districtBarChart');
      if(!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if(districtChart) {
        districtChart.destroy();
      }
      
      const labels = [];
      const values = [];
      const colors = [];
      
      // Prepare data
      fullRankingsData.forEach((entry, index) => {
        labels.push(capitalizeWords(entry[0]));
        values.push(entry[1]);
        
        // Color based on ranking (top 1/3 green, middle yellow, bottom red)
        const total = fullRankingsData.length;
        if(index < total / 3) {
          colors.push('#4caf50'); // Green
        } else if(index < (2 * total) / 3) {
          colors.push('#ffeb3b'); // Yellow
        } else {
          colors.push('#f44336'); // Red
        }
      });
      
      // Calculate state average
      const stateAverage = values.reduce((sum, val) => sum + val, 0) / values.length;
      
      districtChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderColor: '#000000',
            borderWidth: 0.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  return `Value: ${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 10
                }
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          },
          layout: {
            padding: {
              left: 10,
              right: 10,
              top: 10,
              bottom: 10
            }
          }
        },
        plugins: [{
          afterDraw: function(chart) {
            const ctx = chart.ctx;
            const yAxis = chart.scales.y;
            const xAxis = chart.scales.x;
            
            // Draw state average line
            const yPosition = yAxis.getPixelForValue(stateAverage);
            
            ctx.save();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(xAxis.left, yPosition);
            ctx.lineTo(xAxis.right, yPosition);
            ctx.stroke();
            
            // Add label for state average
            ctx.fillStyle = '#666666';
            ctx.font = '12px Inter';
            ctx.fillText(`State Avg: ${stateAverage.toFixed(2)}`, xAxis.right - 120, yPosition - 5);
            ctx.restore();
          }
        }]
      });
    }

    // Dashboard AI Interpretation Functions
    async function generateDashboardInterpretation() {
      if (!currentIndicator) {
        showNotification('Please select an indicator first');
        return;
      }
      
      // Show loading
      document.getElementById('loadingInterpretation').style.display = 'flex';
      document.getElementById('interpretationContent').style.display = 'none';
      
      const surveyLabel = activeSurvey === 'nfhs4' ? 'NFHS-4' : 'NFHS-5';
      const indicatorName = currentIndicator.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      // Get top and bottom districts
      const entries = Object.entries(districtValues).filter(([d,v]) => !isNaN(v));
      const indicatorType = getIndicatorType(currentIndicator);
      
      if(indicatorType === 'Negative') {
        entries.sort((a,b) => a[1] - b[1]);
      } else {
        entries.sort((a,b) => b[1] - a[1]);
      }
      
      const top3 = entries.slice(0, 3).map(([d,v]) => `${capitalizeWords(d)} (${v}%)`).join(', ');
      const bottom3 = entries.slice(-3).map(([d,v]) => `${capitalizeWords(d)} (${v}%)`).join(', ');
      const stateAvg = (entries.reduce((s,[_,v]) => s + v, 0) / entries.length).toFixed(1);
      
      const prompt = `Analyze this Tamil Nadu health indicator data (${surveyLabel}):\n\nIndicator: ${indicatorName}\nState Average: ${stateAvg}%\nTop Performers: ${top3}\nNeeds Attention: ${bottom3}\nTotal Districts: ${entries.length}\n\nProvide a brief professional analysis in 2-3 bullet points focusing on:\n- Key performance patterns\n- Geographic or demographic insights\n- Policy implications for Tamil Nadu\n\nKeep it concise and actionable for health administrators.`;
      
      try {
        const response = await queryFirebaseAI(prompt, {});
        
        // Format response with bullet points
        const bulletResponse = response
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/•\s*/g, '')
          .split('\n')
          .filter(line => line.trim())
          .map(line => `<div style="display: flex; align-items: flex-start; margin-bottom: 6px;"><span style="color: #4285f4; margin-right: 6px; margin-top: 2px;">•</span><span>${line.trim()}</span></div>`)
          .join('');
        
        // Hide loading, show content and open modal
        document.getElementById('loadingInterpretation').style.display = 'none';
        document.getElementById('interpretationContent').style.display = 'block';
        document.getElementById('modalInterpretationText').innerHTML = bulletResponse;
        
        // Update context in modal
        const contextText = `${surveyLabel} • ${indicatorName} • State Average: ${stateAvg}%`;
        document.getElementById('contextDetails').textContent = contextText;
        
        // Auto-open modal after generation
        openDashboardModal();
        
      } catch (error) {
        console.error('Error generating interpretation:', error);
        document.getElementById('loadingInterpretation').style.display = 'none';
        document.getElementById('interpretationContent').style.display = 'block';
        const errorMsg = 'Unable to generate interpretation at this time. Please try again later.';
        document.getElementById('modalInterpretationText').innerHTML = errorMsg;
        
        // Auto-open modal even for errors
        openDashboardModal();
      }
    }

    function openDashboardModal() {
      document.getElementById('dashboardModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeDashboardModal(event) {
      if (!event || event.target === document.getElementById('dashboardModal')) {
        document.getElementById('dashboardModal').style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Hide chatbot widget on dashboard
    document.addEventListener('DOMContentLoaded', function() {
      const hideWidget = () => {
        const chatWidget = document.getElementById('chatbotWidget');
        if (chatWidget) {
          chatWidget.style.display = 'none';
        } else {
          setTimeout(hideWidget, 50);
        }
      };
      hideWidget();
    });
    
    // Also hide with CSS
    const style = document.createElement('style');
    style.textContent = '#chatbotWidget { display: none !important; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    document.head.appendChild(style);

  </script>
</body>