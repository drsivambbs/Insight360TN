<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight360TN - NFHS Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css?v=2">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="material-icons">dashboard</span>
                <h3>NFHS Indicators</h3>
            </div>
            <div class="survey-toggle">
                <button class="toggle-btn active" onclick="toggleSurvey('nfhs4')" id="nfhs4Btn">NFHS-4</button>
                <button class="toggle-btn" onclick="toggleSurvey('nfhs5')" id="nfhs5Btn">NFHS-5</button>
            </div>
            <div id="categoryTree"></div>
        </div>
        
        <div class="main-content">
            <div class="dashboard-header">
                <h1>Insight360TN</h1>
                <p>Tamil Nadu Health Survey Dashboard</p>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="right-sidebar">
            <div id="kpiContainer">
                <h3>Performance Analysis</h3>
                <p>Select an indicator to view analysis</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let categoriesData, nfhsData, geoJsonData, map, activeSurvey = 'nfhs4';
        
        // Load data
        Promise.all([
            fetch('./dashboard_files/nfhs_indicator_categories.json').then(r => r.json()),
            fetch('./dashboard_files/master_nfhs_data.json').then(r => r.json()),
            fetch('./dashboard_files/tn_district.geojson').then(r => r.json())
        ]).then(([categories, nfhs, geojson]) => {
            categoriesData = categories;
            nfhsData = nfhs;
            geoJsonData = geojson;
            initMap();
            renderCategories();
        });
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([10.8, 78.6569], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        // Render categories
        function renderCategories() {
            const tree = document.getElementById('categoryTree');
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            const firstDistrict = Object.values(nfhsData.districts)[0];
            const availableKeys = new Set(Object.keys(firstDistrict[surveyKey]));
            
            tree.innerHTML = '';
            
            Object.entries(categoriesData.categories).forEach(([catKey, catData]) => {
                const indicators = catData.indicators.map(ind => ind.name || ind);
                const available = indicators.filter(name => availableKeys.has(name));
                
                if (available.length > 0) {
                    const div = document.createElement('div');
                    div.className = 'category';
                    div.innerHTML = `
                        <div class="category-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <span class="material-icons">chevron_right</span>
                            <span>${catKey.replace(/_/g, ' ')} (${available.length})</span>
                        </div>
                        <div class="indicators">
                            ${available.map(ind => `<div class="indicator" onclick="selectIndicator('${ind}')">${ind}</div>`).join('')}
                        </div>
                    `;
                    tree.appendChild(div);
                }
            });
        }
        
        // Toggle survey
        function toggleSurvey(survey) {
            activeSurvey = survey;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(survey + 'Btn').classList.add('active');
            renderCategories();
        }
        
        // Select indicator
        function selectIndicator(indicator) {
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            const districtData = [];
            
            Object.entries(nfhsData.districts).forEach(([district, data]) => {
                if (data[surveyKey] && data[surveyKey][indicator] !== undefined) {
                    districtData.push([district, data[surveyKey][indicator]]);
                }
            });
            
            // Update KPI
            document.getElementById('kpiContainer').innerHTML = `
                <h3>${indicator}</h3>
                <p>Survey: ${activeSurvey.toUpperCase()}</p>
                <p>Districts with data: ${districtData.length}</p>
            `;
            
            console.log('Selected:', indicator, 'Data points:', districtData.length);
        }
    </script>
</body>
</html>