<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight360TN - NFHS Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; }
        
        .container { display: flex; height: 100vh; }
        
        .sidebar { width: 350px; background: #1e1e1e; box-shadow: 2px 0 4px rgba(0,0,0,0.3); overflow-y: auto; }
        .sidebar-header { padding: 16px; background: #2196f3; color: white; display: flex; align-items: center; gap: 12px; }
        
        .main-content { flex: 1; padding: 24px; }
        .dashboard-header { background: #1e1e1e; padding: 24px; border-radius: 8px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .dashboard-title { font-size: 28px; font-weight: 300; color: #64b5f6; margin-bottom: 8px; }
        .dashboard-subtitle { color: #b0b0b0; font-size: 16px; }
        .content-area { background: #1e1e1e; padding: 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); min-height: 400px; position: relative; }
        #map { width: 100%; height: 600px; border-radius: 8px; }
        .map-overlay { position: absolute; top: 16px; left: 16px; background: rgba(30,30,30,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); z-index: 1000; color: #e0e0e0; }
        .legend { position: absolute; bottom: 16px; right: 16px; background: rgba(30,30,30,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); z-index: 1000; font-size: 12px; color: #e0e0e0; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-color { width: 16px; height: 16px; margin-right: 8px; border-radius: 2px; }
        
        .right-sidebar { width: 380px; background: #1e1e1e; box-shadow: -2px 0 4px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .right-sidebar-header { padding: 16px; background: #2a2a2a; border-bottom: 1px solid #404040; }
        .right-sidebar-content { flex: 1; padding: 16px; overflow-y: auto; }
        
        .category { border-bottom: 1px solid #404040; }
        .category-header { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; color: #e0e0e0; }
        .category-header:hover { background-color: #2a2a2a; }
        .category-icon { transition: transform 0.2s; }
        .category.expanded .category-icon { transform: rotate(90deg); }
        .category-title { font-weight: 500; flex: 1; }
        .indicator-count { background: #1565c0; color: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        
        .indicators { display: none; background: #2a2a2a; }
        .category.expanded .indicators { display: block; }
        .indicator { padding: 8px 16px 8px 48px; cursor: pointer; transition: background-color 0.2s; border-left: 3px solid transparent; color: #b0b0b0; }
        .indicator:hover { background-color: #1565c0; border-left-color: #64b5f6; color: #e0e0e0; }
        .indicator.selected { background-color: #1565c0; border-left-color: #64b5f6; font-weight: 500; color: #e0e0e0; }
        
        .survey-toggle { display: flex; background: transparent; border-radius: 24px; padding: 4px; flex-direction: column; background: transparent; padding: 0; }
        .toggle-btn { padding: 12px 16px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; color: #b0b0b0; display: flex; align-items: center; margin-bottom: 8px; justify-content: flex-start; width: 100%; }
        .toggle-btn.active { background: #2196f3; color: white; box-shadow: 0 2px 4px rgba(33,150,243,0.3); }
        .toggle-btn:hover:not(.active) { background: #404040; color: #e0e0e0; }
        
        .kpi-section { margin-bottom: 16px; }
        .kpi-title { font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .kpi-cards { display: flex; flex-direction: column; gap: 6px; }
        .kpi-card { background: #2a2a2a; border-radius: 6px; padding: 8px 10px; border-left: 3px solid #2196f3; transition: transform 0.2s, box-shadow 0.2s; font-size: 12px; }
        .kpi-card:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .kpi-card.top { border-left-color: #4caf50; background: linear-gradient(135deg, #1b5e20 0%, #2a2a2a 100%); }
        .kpi-card.bottom { border-left-color: #f44336; background: linear-gradient(135deg, #b71c1c 0%, #2a2a2a 100%); }
        .kpi-card.average { border-left-color: #ff9800; background: linear-gradient(135deg, #e65100 0%, #2a2a2a 100%); }
        .kpi-district { font-size: 12px; font-weight: 500; color: #e0e0e0; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-value { font-size: 16px; font-weight: 700; color: #64b5f6; display: inline; }
        .kpi-rank { font-size: 10px; color: #b0b0b0; margin-top: 2px; display: inline; margin-left: 8px; }
        
        .placeholder { text-align: center; color: #666; padding: 60px 20px; }
        .placeholder .material-icons { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="material-icons">dashboard</span>
                <h3>NFHS Indicators</h3>
            </div>
            <div id="categoryTree"></div>
        </div>
        
        <div class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Insight360TN</h1>
                <p class="dashboard-subtitle">National Family Health Survey Dashboard for Tamil Nadu</p>
            </div>
            
            <div class="content-area">
                <div id="map"></div>
                <div class="map-overlay">
                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">Tamil Nadu Districts</h4>
                    <p style="margin: 0; font-size: 12px; color: #666;">Select an indicator to view district-wise data</p>
                </div>
                <div class="legend" id="mapLegend" style="display: none;">
                    <div style="font-weight: 500; margin-bottom: 8px; color: #333;">Performance Scale</div>
                </div>
            </div>
        </div>
        
        <div class="right-sidebar">
            <div class="right-sidebar-header">
                <h4 style="margin: 0; color: #1976d2; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="font-size: 20px;">tune</span>
                    Survey Selection
                </h4>
            </div>
            <div class="right-sidebar-content">
                <div class="survey-toggle">
                    <button class="toggle-btn active" onclick="toggleSurvey('nfhs4')" id="nfhs4Btn">
                        <span class="material-icons" style="font-size: 16px; margin-right: 8px;">calendar_view_day</span>
                        NFHS-4 (2015-16)
                    </button>
                    <button class="toggle-btn" onclick="toggleSurvey('nfhs5')" id="nfhs5Btn">
                        <span class="material-icons" style="font-size: 16px; margin-right: 8px;">view_agenda</span>
                        NFHS-5 (2019-21)
                    </button>
                </div>
                
                <div id="kpiContainer" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
                    <h5 style="margin: 0 0 12px 0; color: #666; font-weight: 500;">Quick Stats</h5>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 14px;">
                        <div style="margin-bottom: 8px;">üìä Total Categories: <strong>10</strong></div>
                        <div style="margin-bottom: 8px;">üìà Total Indicators: <strong>127</strong></div>
                        <div>üè• Districts Covered: <strong>32</strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let categoriesData = {}, nfhsData = {}, geoJsonData = {}, selectedIndicator = null, activeSurvey = 'nfhs4', map = null;

        // Load data
        Promise.all([
            fetch('./dashboard_files/nfhs_indicator_categories.json').then(r => r.json()),
            fetch('./dashboard_files/master_nfhs_data.json').then(r => r.json()),
            fetch('./dashboard_files/tn_district.geojson').then(r => r.json())
        ]).then(([categories, nfhs, geojson]) => {
            categoriesData = categories;
            nfhsData = nfhs;
            geoJsonData = geojson;
            renderCategoryTree();
            if (map) {
                loadDefaultDistricts();
            }
        }).catch(error => console.error('Error loading data:', error));
        
        let geoJsonLayer = null;
        
        function initMap() {
            map = L.map('map').setView([10.8, 78.6569], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO'
            }).addTo(map);
            
            // Load default district boundaries
            if (geoJsonData && geoJsonData.features) {
                loadDefaultDistricts();
            }
        }
        
        function loadDefaultDistricts() {
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }
            
            geoJsonLayer = L.geoJSON(geoJsonData, {
                style: {
                    fillColor: '#404040',
                    weight: 0.9,
                    opacity: 1,
                    color: '#ffffff',
                    fillOpacity: 0.3
                },
                onEachFeature: function(feature, layer) {
                    const districtName = feature.properties.DISTRICT;
                    layer.bindPopup(`<b>${districtName}</b><br/>Select an indicator to view data`);
                }
            }).addTo(map);
        }
        
        window.onload = function() {
            initMap();
        };

        function renderCategoryTree() {
            const treeContainer = document.getElementById('categoryTree');
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            treeContainer.innerHTML = '';

            Object.entries(categoriesData.categories).forEach(([categoryKey, categoryData]) => {
                const availableIndicators = getAvailableIndicators(categoryData.indicators, surveyKey);
                
                if (availableIndicators.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';
                    categoryDiv.innerHTML = `
                        <div class="category-header" onclick="toggleCategory('${categoryKey}')">
                            <span class="material-icons category-icon">chevron_right</span>
                            <span class="category-title">${formatCategoryName(categoryKey)}</span>
                            <span class="indicator-count">${availableIndicators.length}</span>
                        </div>
                        <div class="indicators">
                            ${availableIndicators.map(indicator => `
                                <div class="indicator" onclick="selectIndicator('${categoryKey}', '${indicator}')">
                                    ${indicator}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    treeContainer.appendChild(categoryDiv);
                }
            });
        }

        function getAvailableIndicators(indicators, surveyKey) {
            if (!nfhsData.districts) return [];
            const firstDistrict = Object.values(nfhsData.districts)[0];
            return firstDistrict && firstDistrict[surveyKey] 
                ? indicators.filter(indicator => firstDistrict[surveyKey][indicator] !== undefined)
                : [];
        }

        function formatCategoryName(categoryKey) {
            return categoryKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function toggleCategory(categoryKey) {
            event.currentTarget.parentElement.classList.toggle('expanded');
        }

        function selectIndicator(categoryKey, indicator) {
            document.querySelectorAll('.indicator.selected').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            selectedIndicator = { category: categoryKey, indicator: indicator };
            updateContentArea(categoryKey, indicator);
        }

        function toggleSurvey(survey) {
            activeSurvey = survey;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(survey + 'Btn').classList.add('active');
            renderCategoryTree();
            selectedIndicator = null;
            document.querySelector('.map-overlay').innerHTML = `
                <h4 style="margin: 0 0 8px 0; color: #1976d2;">Tamil Nadu Districts</h4>
                <p style="margin: 0; font-size: 12px; color: #666;">Select an indicator to view district-wise data</p>
            `;
            document.getElementById('mapLegend').style.display = 'none';
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
                geoJsonLayer = null;
            }
            document.getElementById('kpiContainer').innerHTML = `
                <h5 style="margin: 0 0 12px 0; color: #666; font-weight: 500;">Quick Stats</h5>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 14px;">
                    <div style="margin-bottom: 8px;">üìä Total Categories: <strong>10</strong></div>
                    <div style="margin-bottom: 8px;">üìà Total Indicators: <strong>127</strong></div>
                    <div>üè• Districts Covered: <strong>32</strong></div>
                </div>
            `;
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
                geoJsonLayer = null;
            }
            document.getElementById('mapLegend').style.display = 'none';
        }

        function updateContentArea(categoryKey, indicator) {
            const surveyLabel = activeSurvey === 'nfhs4' ? 'NFHS-4 (2015-16)' : 'NFHS-5 (2019-21)';
            document.querySelector('.map-overlay').innerHTML = `
                <h4 style="margin: 0 0 4px 0; color: #1976d2;">${indicator}</h4>
                <p style="margin: 0 0 4px 0; font-size: 11px; color: #666;">Category: ${formatCategoryName(categoryKey)}</p>
                <span style="background: #1976d2; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">
                    ${surveyLabel}
                </span>
            `;
            loadMapData(indicator);
            generateKPIDashboard(indicator);
        }
        
        function loadMapData(indicator) {
            if (!map || !geoJsonData) return;
            
            const chartData = getChartData(indicator);
            if (!chartData || chartData.length === 0) return;
            
            const values = chartData.map(d => d[1]);
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }
            
            geoJsonLayer = L.geoJSON(geoJsonData, {
                style: function(feature) {
                    const districtName = feature.properties.DISTRICT;
                    const districtData = chartData.find(d => d[0] === districtName);
                    const value = districtData ? districtData[1] : 0;
                    const intensity = (value - min) / (max - min);
                    
                    return {
                        fillColor: getColor(intensity),
                        weight: 0.9,
                        opacity: 1,
                        color: '#ffffff',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const districtName = feature.properties.DISTRICT;
                    const districtData = chartData.find(d => d[0] === districtName);
                    const value = districtData ? districtData[1] : 'No data';
                    layer.bindPopup(`<b>${districtName}</b><br/>${indicator}<br/>Value: ${value}%`);
                }
            }).addTo(map);
            
            showLegend(min, max);
        }
        
        function getColor(intensity) {
            const colors = ['#ffebee', '#ffcdd2', '#ef9a9a', '#e57373', '#ef5350', '#f44336', '#e53935', '#d32f2f', '#c62828', '#b71c1c'];
            return colors[Math.floor(intensity * (colors.length - 1))];
        }
        
        function showLegend(min, max) {
            const legend = document.getElementById('mapLegend');
            legend.style.display = 'block';
            legend.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 8px; color: #333;">Performance Scale (%)</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #b71c1c;"></div>
                    <span>High (${max.toFixed(1)})</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef5350;"></div>
                    <span>Medium</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffebee;"></div>
                    <span>Low (${min.toFixed(1)})</span>
                </div>
            `;
        }

        function generateKPIDashboard(indicator) {
            const chartData = getChartData(indicator);
            const kpiContainer = document.getElementById('kpiContainer');
            
            if (!chartData || chartData.length === 0) {
                kpiContainer.innerHTML = `
                    <h5 style="margin: 0 0 12px 0; color: #666; font-weight: 500;">No Data Available</h5>
                    <div style="background: #ffeaea; padding: 12px; border-radius: 8px; font-size: 12px; color: #666;">
                        Data not available for selected survey
                    </div>
                `;
                return;
            }
            
            const top5 = chartData.slice(0, 5);
            const bottom5 = chartData.slice(-5).reverse();
            const values = chartData.map(d => d[1]);
            const average = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
            
            kpiContainer.innerHTML = `
                <h5 style="margin: 0 0 12px 0; color: #1976d2; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                    <span class="material-icons" style="font-size: 16px;">assessment</span>
                    Performance Analysis
                </h5>
                
                <div class="kpi-section">
                    <div class="kpi-title" style="color: #4caf50;">
                        <span class="material-icons" style="font-size: 14px;">trending_up</span>
                        Top 5 Districts
                    </div>
                    <div class="kpi-cards">
                        ${top5.map((district, index) => `
                            <div class="kpi-card top">
                                <div class="kpi-district">${district[0]}</div>
                                <div class="kpi-value">${district[1]}%</div>
                                <div class="kpi-rank">#${index + 1}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="kpi-section">
                    <div class="kpi-title" style="color: #ff9800;">
                        <span class="material-icons" style="font-size: 14px;">analytics</span>
                        State Average
                    </div>
                    <div class="kpi-cards">
                        <div class="kpi-card average">
                            <div class="kpi-district">Tamil Nadu</div>
                            <div class="kpi-value">${average}%</div>
                            <div class="kpi-rank">${chartData.length} districts</div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-section">
                    <div class="kpi-title" style="color: #f44336;">
                        <span class="material-icons" style="font-size: 14px;">trending_down</span>
                        Bottom 5 Districts
                    </div>
                    <div class="kpi-cards">
                        ${bottom5.map((district, index) => `
                            <div class="kpi-card bottom">
                                <div class="kpi-district">${district[0]}</div>
                                <div class="kpi-value">${district[1]}%</div>
                                <div class="kpi-rank">#${chartData.length - index}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getChartData(indicator) {
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            const districtData = [];
            const districts = nfhsData.districts || {};
            
            Object.entries(districts).forEach(([districtName, districtInfo]) => {
                if (districtInfo[surveyKey] && districtInfo[surveyKey][indicator] !== undefined) {
                    const value = parseFloat(districtInfo[surveyKey][indicator]);
                    if (!isNaN(value)) {
                        districtData.push([districtName, value]);
                    }
                }
            });
            
            return districtData.sort((a, b) => b[1] - a[1]);
        }
    </script>
</body>
</html>