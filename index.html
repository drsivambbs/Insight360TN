<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insight360TN — Professional NFHS Dashboard</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Material icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body,#app{height:100vh;margin:0;background:var(--bg);overflow:hidden}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:18px;padding:18px;height:100vh;align-items:start;box-sizing:border-box}
    .left-column{display:flex;flex-direction:column;gap:12px}

    /* Sidebar */
    .sidebar{background:linear-gradient(180deg,#ffffff, #fbfdff);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(22,38,99,0.06);height:calc(88vh - 36px)}
    .sidebar-header{display:flex;align-items:center;gap:12px}
    .sidebar-header h3{margin:0;font-size:15px}
    .survey-toggle{display:flex;gap:8px;margin-top:12px}
    .toggle-btn{flex:1;padding:6px;border-radius:8px;border:1px solid #e6eefb;background:#fff;cursor:pointer;font-size:13px}
    .toggle-btn.active{background:var(--accent);color:#fff;border-color:transparent}

    #categoryTree{margin-top:14px;max-height:calc(100vh - 160px);overflow:auto;padding-right:6px;font-size:14px}
    .category{border-radius:8px;padding:6px;margin-bottom:6px;transition:all 0.2s ease}
    .category-header{display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;color:#0f172a;font-size:13px}
    .category.expanded .material-icons{transform:rotate(90deg)}
    .category .material-icons{transition:transform 0.2s ease;font-size:17px}
    .indicators{margin-top:6px;display:grid;grid-template-columns:1fr;gap:4px;max-height:0;overflow:hidden;transition:max-height 0.3s ease}
    .category.expanded .indicators{max-height:500px}
    .indicator{padding:6px 8px;border-radius:6px;background:rgba(15,23,42,0.03);cursor:pointer;font-size:12px;line-height:1.3}
    .indicator:hover{background:rgba(37,99,235,0.06)}

    /* Main */
    .main{display:flex;flex-direction:column;gap:12px}
    .header{display:flex;justify-content:space-between;align-items:center}
    .title{display:flex;flex-direction:column}
    .title h1{margin:0;font-size:20px}
    .title p{margin:0;color:var(--muted);font-size:13px}

    .map-card{height:68vh;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(22,38,99,0.06);background:var(--card)}
    #map{height:100%;width:100%}

    /* Right sidebar */
    .right{display:flex;flex-direction:column;gap:12px}
    .kpi-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 4px 14px rgba(2,6,23,0.03)}
    .card h4{margin:0;font-size:13px}
    .card .value{font-size:20px;font-weight:700;margin-top:6px}

    .legend{padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.9), rgba(255,255,255,0.75));box-shadow:0 6px 24px rgba(15,23,42,0.04)}

    /* small responsive */
    @media (max-width:1100px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;padding:10px}.sidebar{order:3}.right{order:2}.main{order:1}}

    /* tooltip */
    .info-box{position:absolute;z-index:9999;pointer-events:none;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.08);font-size:13px}
  </style>
</head>

<body>
  <div id="app" class="app">

    <!-- LEFT: controls -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="material-icons" style="color:var(--accent)">dashboard</span>
        <div>
          <h3>NFHS Indicators</h3>
          <div style="font-size:12px;color:var(--muted)">Tamil Nadu — Insight360TN</div>
        </div>
      </div>

      <div class="survey-toggle" style="margin-top:12px">
        <button id="nfhs4Btn" class="toggle-btn active" onclick="toggleSurvey('nfhs4')">NFHS-4</button>
        <button id="nfhs5Btn" class="toggle-btn" onclick="toggleSurvey('nfhs5')">NFHS-5</button>
      </div>

      <div style="margin-top:12px">
        <input id="searchIndicator" placeholder="Search indicators..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb" />
      </div>

      <div id="categoryTree"></div>
    </aside>

    <!-- MAIN: map + header -->
    <main class="main">
      <div class="header">
        <div class="title">
          <h1>Insight360TN</h1>
          <p>Tamil Nadu Health Survey Dashboard</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Active survey:</div>
          <strong id="activeSurveyLabel">NFHS-4</strong>
        </div>
      </div>

      <div class="map-card">
        <div id="map"></div>
      </div>

      <!-- Stats cards below map -->
      <div id="statsGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px"></div>
    </main>

    <!-- RIGHT: KPIs & charts -->
    <aside class="right">
      <div class="card">
        <h4 id="indicatorTitle">Select an indicator</h4>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div style="font-size:12px;color:var(--muted)">Survey:</div>
          <div id="indicatorSurvey" style="font-weight:600">-</div>
        </div>
        <div id="kpiRow" style="margin-top:12px" class="kpi-cards"></div>
      </div>

      <div class="card">
        <h4>District Rankings</h4>
        <div id="districtRankings"></div>
      </div>

      <div class="card legend" id="legendContainer">
        <h4 style="margin-top:0">Map legend</h4>
        <div id="legend"></div>
      </div>

    </aside>
  </div>

  <div id="info" class="info-box" style="display:none"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- state ---
    let categoriesData, nfhsData, geoJsonData, map, activeSurvey = 'nfhs4', currentLayer, currentIndicator, districtValues = {};
    const colorScale = [ '#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#3182bd','#08519c' ];

    // Load all data (user's local files assumed) and initialize
    Promise.all([
      fetch('./dashboard_files/nfhs_indicator_categories.json').then(r=>r.json()),
      fetch('./dashboard_files/master_nfhs_data.json').then(r=>r.json()),
      fetch('./dashboard_files/tn_district.geojson').then(r=>r.json())
    ]).then(([categories, nfhs, geojson]) => {
      categoriesData = categories;
      nfhsData = nfhs;
      geoJsonData = geojson;
      initMap();
      renderCategories();
      renderStats();
    }).catch(err=>{
      console.error('Failed to load data', err);
      alert('Failed to load dashboard files. Check paths in console.');
    });

    function initMap(){
      map = L.map('map', {zoomControl:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:''}).addTo(map);
      L.control.zoom({position:'topright'}).addTo(map);

      // Add GeoJSON layer with default styling
      if(geoJsonData){
        currentLayer = L.geoJSON(geoJsonData, {style: defaultStyle}).addTo(map);
        map.fitBounds(currentLayer.getBounds(), {padding:[5,5]});
        setTimeout(() => map.setZoom(map.getZoom() + 1), 100);
      }

      // Info control
      map.on('mousemove', function(e){ let info = document.getElementById('info'); info.style.left = (e.originalEvent.clientX+12)+'px'; info.style.top = (e.originalEvent.clientY+12)+'px'; });
    }

    function defaultStyle(){ return {color:'#000000',weight:0.8,fillColor:'#efefef',fillOpacity:0} }

    // --- categories UI ---
    function renderCategories(){
      const tree = document.getElementById('categoryTree');
      const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
      const firstDistrict = Object.values(nfhsData.districts)[0];
      const availableKeys = new Set(Object.keys(firstDistrict[surveyKey] || {}));

      tree.innerHTML = '';
      Object.entries(categoriesData.categories).forEach(([catKey, catData])=>{
        const indicators = catData.indicators.map(i => (typeof i === 'string'? i: (i.name||i))).filter(Boolean);
        const available = indicators.filter(name => availableKeys.has(name));
        if(!available.length) return;

        const div = document.createElement('div'); div.className = 'category';
        const header = document.createElement('div'); header.className='category-header'; header.innerHTML = `<span class="material-icons">chevron_right</span><span>${catKey.replace(/_/g,' ')} (${available.length})</span>`;
        header.onclick = ()=> div.classList.toggle('expanded');
        div.appendChild(header);

        const inner = document.createElement('div'); inner.className='indicators';
        available.forEach(ind=>{
          const el = document.createElement('div'); el.className='indicator'; el.textContent = ind; el.onclick = ()=> selectIndicator(ind);
          inner.appendChild(el);
        });
        div.appendChild(inner);
        tree.appendChild(div);
      });

      // wire search
      const search = document.getElementById('searchIndicator');
      search.oninput = ()=>{
        const q = search.value.trim().toLowerCase();
        document.querySelectorAll('.indicator').forEach(el=>{
          el.style.display = el.textContent.toLowerCase().includes(q)?'block':'none';
        });
      }
    }

    function toggleSurvey(survey){ activeSurvey = survey; document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active')); document.getElementById(survey+'Btn').classList.add('active'); document.getElementById('activeSurveyLabel').textContent = survey.toUpperCase(); renderCategories(); if(currentIndicator) selectIndicator(currentIndicator); }

    // --- indicator selection and map coloring ---
    function selectIndicator(indicator){
      currentIndicator = indicator;
      document.getElementById('indicatorTitle').textContent = indicator;
      document.getElementById('indicatorSurvey').textContent = activeSurvey.toUpperCase();

      // Collapse all categories after selection
      const expandedCategories = document.querySelectorAll('.category.expanded');
      console.log('Auto-collapsing', expandedCategories.length, 'categories');
      expandedCategories.forEach(cat => cat.classList.remove('expanded'));

      // Get indicator type
      const indicatorType = getIndicatorType(indicator);

      // District mapping for newly formed districts
      const districtMapping = {
        'chengalpattu': 'kanchipuram',
        'kallakurichi': 'villupuram', 
        'mayiladuthurai': 'nagapattinam',
        'ranipet': 'vellore',
        'tenkasi': 'tirunelveli',
        'tirupathur': 'vellore'
      };

      // gather district values
      const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
      districtValues = {};
      Object.entries(nfhsData.districts).forEach(([district, data])=>{
        const v = data[surveyKey] && data[surveyKey][indicator];
        if(v!==undefined && v!==null && v!=="" ) {
          districtValues[district.toLowerCase()] = +v;
          // Map to newly formed districts
          Object.entries(districtMapping).forEach(([newDist, parentDist]) => {
            if(district.toLowerCase() === parentDist) {
              districtValues[newDist] = +v;
            }
          });
        }
      });

      // compute tertiles for 3 colors
      const vals = Object.values(districtValues).filter(v=>!isNaN(v)).sort((a,b)=>a-b);
      const tertiles = computeTertiles(vals);

      // update legend
      renderLegend(tertiles, indicatorType);

      // style geojson
      if(currentLayer) map.removeLayer(currentLayer);
      currentLayer = L.geoJSON(geoJsonData, {style: feat=>{
        const name = (feat.properties && (feat.properties.District || feat.properties.DISTRICT || feat.properties.district || feat.properties.NAME)) || '';
        const val = districtValues[name.toLowerCase()];
        return {fillColor: getColorForValue(val, tertiles, indicatorType), weight:0.8, color:'#000', fillOpacity: val===undefined?0.6:0.8}
      }, onEachFeature}).addTo(map);

      // update KPIs + chart
      updateKPIsAndChart(districtValues, indicator);
    }

    function getIndicatorType(indicator){
      for(const [catKey, catData] of Object.entries(categoriesData.categories)){
        for(const ind of catData.indicators){
          const indName = typeof ind === 'string' ? ind : ind.name;
          if(indName === indicator){
            return typeof ind === 'object' ? ind.indicator_type : 'Positive';
          }
        }
      }
      return 'Positive';
    }

    function computeTertiles(vals){
      if(vals.length < 3) return vals;
      const third = Math.floor(vals.length / 3);
      return [vals[third], vals[third * 2]];
    }

    function getColorForValue(v, tertiles, indicatorType){
      if(v===undefined || isNaN(v)) return '#cccccc';
      if(tertiles.length < 2) return '#ffeb3b';
      
      if(indicatorType === 'Positive' || indicatorType === 'Neutral'){
        if(v <= tertiles[0]) return '#f44336';
        if(v <= tertiles[1]) return '#ffeb3b';
        return '#4caf50';
      } else if(indicatorType === 'Negative'){
        if(v <= tertiles[0]) return '#4caf50';
        if(v <= tertiles[1]) return '#ffeb3b';
        return '#f44336';
      }
      return '#ffeb3b';
    }

    function onEachFeature(feature, layer){
      layer.on({ mouseover: (e)=>{
        const el = e.target; el.setStyle({weight:2,fillOpacity:1});
        const props = feature.properties||{}; const name = props.District || props.DISTRICT || props.district || props.NAME || '—';
        const value = districtValues[name.toLowerCase()] || 'No data';
        const info = document.getElementById('info'); info.style.display='block'; info.innerHTML = `<strong>${name}</strong><div style="color:var(--muted);font-size:12px">${value}</div>`;
      }, mouseout: (e)=>{ const el=e.target; try{ currentLayer.resetStyle(el); }catch(e){} document.getElementById('info').style.display='none'; }, click: (e)=>{ map.fitBounds(e.target.getBounds()); } });
    }

    // compute quantile breaks (k groups)
    function computeQuantiles(arr, k){ if(!arr.length) return []; const breaks=[]; for(let i=1;i<=k;i++){ const p = i/(k+1); const idx = p*(arr.length-1); const lo = Math.floor(idx); const hi = Math.ceil(idx); const val = lo===hi ? arr[lo] : arr[lo] + (arr[hi]-arr[lo])*(idx-lo); breaks.push(Number(val.toFixed(3))); } return breaks; }

    function renderLegend(tertiles, indicatorType){
      const container = document.getElementById('legend');
      container.innerHTML='';
      
      if(!tertiles.length){
        container.innerHTML = '<div style="color:var(--muted)">No data available</div>';
        return;
      }
      
      const list = document.createElement('div');
      list.style.display='grid';
      list.style.gridTemplateColumns='1fr';
      list.style.gap='6px';
      
      const colors = ['#4caf50', '#ffeb3b', '#f44336', '#cccccc'];
      const labels = indicatorType === 'Positive' ? ['Best', 'Medium', 'Worst', 'No Data'] : ['Best', 'Medium', 'Worst', 'No Data'];
      
      for(let i=0; i<4; i++){
        const label = document.createElement('div');
        label.style.display='flex';
        label.style.alignItems='center';
        label.style.gap='8px';
        
        const sw = document.createElement('div');
        sw.style.width='28px';
        sw.style.height='12px';
        sw.style.borderRadius='4px';
        sw.style.background = colors[i];
        sw.style.boxShadow='inset 0 -2px rgba(0,0,0,0.05)';
        
        const text = document.createElement('div');
        text.style.fontSize='13px';
        text.style.color='var(--muted)';
        text.textContent = labels[i];
        
        label.appendChild(sw);
        label.appendChild(text);
        list.appendChild(label);
      }
      
      container.appendChild(list);
    }

    // KPI & Rankings
    function updateKPIsAndChart(districtValues, indicator){
      const entries = Object.entries(districtValues).map(([d,v])=>[d,v]).filter(([d,v])=>!isNaN(v));
      const indicatorType = getIndicatorType(indicator);
      
      // Sort based on indicator type
      if(indicatorType === 'Negative'){
        entries.sort((a,b)=>a[1]-b[1]); // Lower is better for negative indicators
      } else {
        entries.sort((a,b)=>b[1]-a[1]); // Higher is better for positive/neutral indicators
      }
      
      const top = entries.slice(0,3);
      const total = entries.length;
      const avg = (entries.reduce((s,[_d,v])=>s+v,0)/Math.max(1,entries.length)).toFixed(2);

      // KPI cards
      const kpiRow = document.getElementById('kpiRow'); kpiRow.innerHTML='';
      const makeCard = (title, value) => { const c = document.createElement('div'); c.className='card'; c.style.padding='10px'; c.innerHTML = `<div style="font-size:12px;color:var(--muted)">${title}</div><div class="value">${value}</div>`; return c; };
      kpiRow.appendChild(makeCard('Districts with data', total));
      kpiRow.appendChild(makeCard('Avg value', avg));
      kpiRow.appendChild(makeCard('Top district', top[0]? capitalizeWords(top[0][0]) : 'N/A'));
      kpiRow.appendChild(makeCard('Top value', top[0]? top[0][1] : 'N/A'));

      // District rankings
      renderDistrictRankings(entries, indicatorType);
    }

    function renderDistrictRankings(entries, indicatorType){
      const container = document.getElementById('districtRankings');
      if(!entries.length){
        container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">No data available</div>';
        return;
      }

      const top3 = entries.slice(0,3);
      const bottom3 = entries.slice(-3).reverse();
      
      container.innerHTML = `
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead>
            <tr style="background:#f8f9fa;border-bottom:1px solid #e9ecef">
              <th style="text-align:left;padding:6px 8px;font-weight:600;color:var(--muted)">Rank</th>
              <th style="text-align:left;padding:6px 8px;font-weight:600;color:var(--muted)">District</th>
              <th style="text-align:right;padding:6px 8px;font-weight:600;color:var(--muted)">Value</th>
            </tr>
          </thead>
          <tbody>
            ${top3.map((entry, i) => `
              <tr style="border-bottom:1px solid #f1f3f4">
                <td style="padding:6px 8px">
                  <span style="background:#4caf50;color:white;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600">${i+1}</span>
                </td>
                <td style="padding:6px 8px;font-weight:500">${capitalizeWords(entry[0])}</td>
                <td style="padding:6px 8px;text-align:right;font-weight:600;color:#4caf50">${entry[1]}</td>
              </tr>
            `).join('')}
            <tr><td colspan="3" style="padding:4px;background:#f8f9fa"></td></tr>
            ${bottom3.map((entry, i) => `
              <tr style="border-bottom:1px solid #f1f3f4">
                <td style="padding:6px 8px">
                  <span style="background:#f44336;color:white;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600">${entries.length - 2 + i}</span>
                </td>
                <td style="padding:6px 8px;font-weight:500">${capitalizeWords(entry[0])}</td>
                <td style="padding:6px 8px;text-align:right;font-weight:600;color:#f44336">${entry[1]}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function capitalizeWords(s){ return s.split(/[_\s]+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }

    function renderStats(){
      const statsGrid = document.getElementById('statsGrid');
      const totalIndicators = Object.values(categoriesData.categories).reduce((sum, cat) => sum + cat.indicators.length, 0);
      const nfhs4Count = Object.keys(Object.values(nfhsData.districts)[0].nfhs_4 || {}).length;
      const nfhs5Count = Object.keys(Object.values(nfhsData.districts)[0].nfhs_5 || {}).length;
      const positiveCount = Object.values(categoriesData.categories).reduce((sum, cat) => sum + cat.indicators.filter(i => (typeof i === 'object' ? i.indicator_type : categoriesData.indicator_types?.[i]) === 'Positive').length, 0);
      const negativeCount = Object.values(categoriesData.categories).reduce((sum, cat) => sum + cat.indicators.filter(i => (typeof i === 'object' ? i.indicator_type : categoriesData.indicator_types?.[i]) === 'Negative').length, 0);
      const categoryCount = Object.keys(categoriesData.categories).length;

      const makeStatItem = (label, value, color = 'var(--accent)') => `<div class="card" style="padding:8px;text-align:center;min-height:50px;display:flex;flex-direction:column;justify-content:center"><div style="font-size:18px;font-weight:700;color:${color}">${value}</div><div style="font-size:10px;color:var(--muted);margin-top:2px">${label}</div></div>`;
      
      statsGrid.innerHTML = [
        makeStatItem('Total', totalIndicators, 'var(--accent)'),
        makeStatItem('Categories', categoryCount, 'var(--accent)'),
        makeStatItem('Positive', positiveCount, '#10b981'),
        makeStatItem('NFHS-4', nfhs4Count, '#6366f1'),
        makeStatItem('NFHS-5', nfhs5Count, '#8b5cf6'),
        makeStatItem('Negative', negativeCount, '#ef4444')
      ].join('');
    }

  </script>
</body>