<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight360TN - NFHS Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #ffffff !important; color: #333333 !important; font-size: 16px; }
        .container { display: flex; height: 100vh; background: #f5f5f5 !important; }
        .sidebar { width: 350px; background: #ffffff !important; border-right: 3px solid #2196F3 !important; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { background: linear-gradient(135deg, #2196F3, #1976D2) !important; color: white !important; padding: 25px 20px; display: flex; align-items: center; gap: 15px; }
        .sidebar-header h3 { font-size: 20px; font-weight: 600; color: white !important; }
        .survey-toggle { margin: 25px 20px; display: flex; background: #f0f0f0 !important; border-radius: 10px; padding: 5px; }
        .toggle-btn { flex: 1; padding: 15px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; color: #666666; }
        .toggle-btn.active { background: #2196F3 !important; color: white !important; }
        .category-header { padding: 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; background: #ffffff !important; font-weight: 600; color: #333333 !important; }
        .category-header:hover { background: #f8f9fa !important; color: #2196F3 !important; }
        .indicators { display: none; background: #fafafa !important; }
        .category.expanded .indicators { display: block; }
        .indicator { padding: 15px 20px 15px 60px; cursor: pointer; color: #555555 !important; font-size: 14px; }
        .indicator:hover { background: #e3f2fd !important; color: #1976D2 !important; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: #f8f9fa !important; }
        .dashboard-header { background: #ffffff !important; padding: 40px; border-bottom: 3px solid #2196F3 !important; }
        .dashboard-header h1 { font-size: 32px; font-weight: 700; color: #1976D2 !important; margin-bottom: 10px; }
        .dashboard-header p { font-size: 18px; color: #666666 !important; }
        #map { flex: 1; margin: 25px; border-radius: 12px; border: 3px solid #e0e0e0; background: #ffffff !important; }
        .right-sidebar { width: 380px; background: #ffffff !important; border-left: 3px solid #2196F3 !important; }
        #kpiContainer { padding: 40px 30px; }
        #kpiContainer h3 { font-size: 22px; font-weight: 700; color: #1976D2 !important; margin-bottom: 20px; }
        #kpiContainer p { font-size: 16px; color: #666666 !important; background: #f8f9fa !important; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="material-icons">dashboard</span>
                <h3>NFHS Indicators</h3>
            </div>
            <div class="survey-toggle">
                <button class="toggle-btn active" onclick="toggleSurvey('nfhs4')" id="nfhs4Btn">NFHS-4</button>
                <button class="toggle-btn" onclick="toggleSurvey('nfhs5')" id="nfhs5Btn">NFHS-5</button>
            </div>
            <div id="categoryTree"></div>
        </div>
        
        <div class="main-content">
            <div class="dashboard-header">
                <h1>Insight360TN</h1>
                <p>Tamil Nadu Health Survey Dashboard</p>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="right-sidebar">
            <div id="kpiContainer">
                <h3>Performance Analysis</h3>
                <p>Select an indicator to view analysis</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let categoriesData, nfhsData, geoJsonData, map, activeSurvey = 'nfhs4';
        
        // Load data
        Promise.all([
            fetch('./dashboard_files/nfhs_indicator_categories.json').then(r => r.json()),
            fetch('./dashboard_files/master_nfhs_data.json').then(r => r.json()),
            fetch('./dashboard_files/tn_district.geojson').then(r => r.json())
        ]).then(([categories, nfhs, geojson]) => {
            categoriesData = categories;
            nfhsData = nfhs;
            geoJsonData = geojson;
            initMap();
            renderCategories();
        });
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([10.8, 78.6569], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        // Render categories
        function renderCategories() {
            const tree = document.getElementById('categoryTree');
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            const firstDistrict = Object.values(nfhsData.districts)[0];
            const availableKeys = new Set(Object.keys(firstDistrict[surveyKey]));
            
            tree.innerHTML = '';
            
            Object.entries(categoriesData.categories).forEach(([catKey, catData]) => {
                const indicators = catData.indicators.map(ind => ind.name || ind);
                const available = indicators.filter(name => availableKeys.has(name));
                
                if (available.length > 0) {
                    const div = document.createElement('div');
                    div.className = 'category';
                    div.innerHTML = `
                        <div class="category-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <span class="material-icons">chevron_right</span>
                            <span>${catKey.replace(/_/g, ' ')} (${available.length})</span>
                        </div>
                        <div class="indicators">
                            ${available.map(ind => `<div class="indicator" onclick="selectIndicator('${ind}')">${ind}</div>`).join('')}
                        </div>
                    `;
                    tree.appendChild(div);
                }
            });
        }
        
        // Toggle survey
        function toggleSurvey(survey) {
            activeSurvey = survey;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(survey + 'Btn').classList.add('active');
            renderCategories();
        }
        
        // Select indicator
        function selectIndicator(indicator) {
            const surveyKey = activeSurvey === 'nfhs4' ? 'nfhs_4' : 'nfhs_5';
            const districtData = [];
            
            Object.entries(nfhsData.districts).forEach(([district, data]) => {
                if (data[surveyKey] && data[surveyKey][indicator] !== undefined) {
                    districtData.push([district, data[surveyKey][indicator]]);
                }
            });
            
            // Update KPI
            document.getElementById('kpiContainer').innerHTML = `
                <h3>${indicator}</h3>
                <p>Survey: ${activeSurvey.toUpperCase()}</p>
                <p>Districts with data: ${districtData.length}</p>
            `;
            
            console.log('Selected:', indicator, 'Data points:', districtData.length);
        }
    </script>
</body>
</html>