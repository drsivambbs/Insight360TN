<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District Analysis — Insight360TN</title>

  <!-- Material icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --warning:#f59e0b;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body,#app{height:100vh;margin:0;background:var(--bg);overflow:hidden}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;padding:12px;height:100vh;align-items:start;box-sizing:border-box}

    /* Header */
    .header{grid-column:1/-1;background:var(--card);padding:8px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(2,6,23,0.04);border-bottom:1px solid #e6eefb;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
    .brand{display:flex;align-items:center;gap:14px}
    .badge{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0b62a8);display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{margin:0;font-size:20px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    /* District Selector */
    .district-selector{display:flex;align-items:center;gap:12px}
    .district-selector select{padding:10px 16px;border-radius:10px;border:2px solid var(--accent);background:var(--card);font-size:14px;min-width:220px;font-weight:600;color:#0f172a;box-shadow:0 2px 8px rgba(37,99,235,0.1);transition:all 0.2s ease}
    .district-selector select:focus{outline:none;border-color:#1d4ed8;box-shadow:0 4px 12px rgba(37,99,235,0.2)}
    .district-selector label{font-size:14px;color:#0f172a;font-weight:600}

    /* Sidebar */
    .sidebar{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(22,38,99,0.06);height:calc(90vh - 80px);overflow-y:auto}
    .sidebar h3{margin:0 0 16px;font-size:16px;color:#0f172a}

    /* Main Content */
    .main{display:flex;flex-direction:column;gap:16px;height:calc(90vh - 80px);overflow-y:auto}

    /* Cards */
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(2,6,23,0.03);border:1px solid #e6eefb}
    .card h3{margin:0 0 12px;font-size:18px;color:#0f172a}
    .card h4{margin:0 0 8px;font-size:14px;color:#0f172a;font-weight:600}

    /* Performance Cards */
    .performance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .performance-card{text-align:center;padding:24px}
    .performance-card.good{background:linear-gradient(135deg,#dcfce7,#bbf7d0);border-left:4px solid var(--success)}
    .performance-card.average{background:linear-gradient(135deg,#fef3c7,#fde68a);border-left:4px solid var(--warning)}
    .performance-card.poor{background:linear-gradient(135deg,#fee2e2,#fecaca);border-left:4px solid var(--danger)}

    .rank-number{font-size:36px;font-weight:700;margin-bottom:8px}
    .rank-label{font-size:14px;color:var(--muted);margin-bottom:4px}
    .performance-label{font-size:16px;font-weight:600;margin-bottom:8px}
    .trend-indicator{display:flex;align-items:center;justify-content:center;gap:4px;font-size:14px}

    /* Category Grid */
    .category-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .category-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:rgba(0,0,0,0.02)}
    .category-rank{display:flex;align-items:center;gap:8px}
    .rank-badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;color:white}
    .rank-badge.good{background:var(--success)}
    .rank-badge.average{background:var(--warning)}
    .rank-badge.poor{background:var(--danger)}

    /* Progress Section */
    .progress-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9}
    .progress-item:last-child{border-bottom:none}

    /* Right Panel */
    .right{display:flex;flex-direction:column;gap:16px;height:calc(90vh - 80px);overflow-y:auto}

    /* Tables */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9}
    th{background:#f8fafc;font-weight:600;color:var(--muted)}

    /* Animations */
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsive */
    @media (max-width:1100px){.app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr auto;padding:10px}.header{margin-bottom:8px}.sidebar{order:4;height:auto}.main{order:2;height:auto}.right{order:3;height:auto}}
  </style>
</head>

<body>
  <div id="app" class="app">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="badge"><span class="material-icons" style="font-size:26px;color:white">map</span></div>
        <div>
          <div style="display:flex;align-items:center;gap:12px">
            <h1 style="margin:0">Insight360TN</h1>
            <div id="selectedDistrictBadge" style="background:linear-gradient(135deg,var(--accent),#1e40af);color:white;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;display:none">
              <span class="material-icons" style="font-size:14px;margin-right:4px">location_on</span>
              <span id="selectedDistrictText">Ariyalur</span>
            </div>
          </div>
          <p id="headerSubtitle" style="margin:4px 0 0">District Analysis — Tamil Nadu Health Dashboard</p>
        </div>
      </div>
      
      <div class="district-selector">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="material-icons" style="font-size:18px;color:var(--accent)">location_on</span>
          <label>Select District:</label>
        </div>
        <select id="districtSelect" onchange="loadDistrictData()">
        </select>
      </div>
    </div>

    <!-- Left Sidebar -->
    <aside class="sidebar">
      <!-- District Card -->
      <div class="card" style="margin-bottom:16px;padding:8px">
        <div id="districtInfo">
          <p style="color:var(--muted);text-align:center;padding:16px">Select a district to view analysis</p>
        </div>
      </div>
      
      <!-- Progress Chart -->
      <div class="card" style="padding:16px">
        <h4 style="margin:0 0 12px;text-align:center">NFHS-4 vs NFHS-5 Progress</h4>
        <div style="position:relative;height:150px;display:flex;align-items:center;justify-content:center">
          <canvas id="progressChart" width="150" height="150"></canvas>
          <div id="chartPlaceholder" style="color:var(--muted);text-align:center;font-size:12px">Select a district to view progress</div>
        </div>
        <div id="progressLegend" style="margin-top:12px;display:none">
          <div style="display:flex;justify-content:space-around;font-size:12px">
            <div style="display:flex;align-items:center;gap:4px">
              <div style="width:12px;height:12px;background:var(--success);border-radius:50%"></div>
              <span>Improved</span>
            </div>
            <div style="display:flex;align-items:center;gap:4px">
              <div style="width:12px;height:12px;background:var(--warning);border-radius:50%"></div>
              <span>Same</span>
            </div>
            <div style="display:flex;align-items:center;gap:4px">
              <div style="width:12px;height:12px;background:var(--danger);border-radius:50%"></div>
              <span>Declined</span>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Overall Performance -->
      <div class="card">
        <h3>Overall Performance</h3>
        <div id="overallPerformance">
          <p style="color:var(--muted);text-align:center;padding:20px">Select a district to view performance</p>
        </div>
      </div>

      <!-- Category Performance -->
      <div class="card">
        <h3>Category-wise Performance</h3>
        <div id="categoryPerformance">
          <p style="color:var(--muted);text-align:center;padding:20px">Select a district to view categories</p>
        </div>
      </div>


    </main>

    <!-- Right Panel -->
    <aside class="right">
      <!-- Category Rankings -->
      <div class="card">
        <h3>Category-wise Median Ranks</h3>
        <div id="categoryRankings">
          <p style="color:var(--muted);text-align:center;padding:20px">Select a district to view category rankings</p>
        </div>
      </div>


    </aside>
  </div>

  <!-- Floating Menu -->
  <div id="hamburgerMenu" style="position:fixed;bottom:20px;right:20px;z-index:10000">
    <div id="menuButton" style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:12px;border-radius:12px;cursor:pointer;box-shadow:0 8px 24px rgba(37,99,235,0.4);transition:all 0.3s ease" onclick="toggleMenu()">
      <span class="material-icons" style="font-size:20px">menu</span>
    </div>
    <div id="menuItems" style="position:absolute;bottom:60px;right:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.3);padding:8px;display:none;flex-direction:column;gap:6px;min-width:140px">
      <div style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.location.href='index.html'">
        <span class="material-icons" style="font-size:16px">home</span>
        <span>Home</span>
      </div>
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.location.href='dashboard.html'">
        <span class="material-icons" style="font-size:16px">dashboard</span>
        <span>Dashboard</span>
      </div>
      <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500" onclick="window.open('https://github.com/drsivambbs/Insight360TN','_blank')">
        <span class="material-icons" style="font-size:16px">code</span>
        <span>GitHub</span>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let nfhsData, categoriesData, currentDistrict = '';
    let menuOpen = false;
    let progressChart = null;

    // Load data and initialize
    Promise.all([
      fetch('./dashboard_files/master_nfhs_data.json').then(r=>r.json()),
      fetch('./dashboard_files/nfhs_indicator_categories.json').then(r=>r.json())
    ]).then(([nfhs, categories]) => {
      nfhsData = nfhs;
      categoriesData = categories;
      populateDistrictSelector();
    }).catch(err => {
      console.error('Failed to load data', err);
      alert('Failed to load data files.');
    });

    function populateDistrictSelector() {
      const select = document.getElementById('districtSelect');
      const districts = Object.keys(nfhsData.districts).sort();
      
      // Add Ariyalur first as default
      if (districts.includes('ariyalur')) {
        const ariyalurOption = document.createElement('option');
        ariyalurOption.value = 'ariyalur';
        ariyalurOption.textContent = 'Ariyalur';
        ariyalurOption.selected = true;
        select.appendChild(ariyalurOption);
      }
      
      // Add other districts
      districts.forEach(district => {
        if (district !== 'ariyalur') {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = capitalizeWords(district);
          select.appendChild(option);
        }
      });
      
      // Load Ariyalur data by default
      loadDistrictData();
    }

    function loadDistrictData() {
      const select = document.getElementById('districtSelect');
      currentDistrict = select.value;
      
      // Update header with district name
      const headerSubtitle = document.getElementById('headerSubtitle');
      const selectedDistrictBadge = document.getElementById('selectedDistrictBadge');
      const selectedDistrictText = document.getElementById('selectedDistrictText');
      
      if (!currentDistrict) {
        headerSubtitle.textContent = 'District Analysis — Tamil Nadu Health Dashboard';
        selectedDistrictBadge.style.display = 'none';
        resetViews();
        return;
      }
      
      // Show district badge and update text
      selectedDistrictBadge.style.display = 'flex';
      selectedDistrictBadge.style.alignItems = 'center';
      selectedDistrictText.textContent = capitalizeWords(currentDistrict);
      headerSubtitle.textContent = 'District Analysis — Tamil Nadu Health Dashboard';

      const districtData = nfhsData.districts[currentDistrict];
      if (!districtData) return;

      // Calculate rankings for this district
      const rankings = calculateDistrictRankings(currentDistrict);
      
      // Update all sections
      updateDistrictInfo(currentDistrict, rankings);
      updateProgressChart(rankings);
      updateOverallPerformance(rankings);
      updateCategoryPerformance(rankings);
      updateCategoryRankings(rankings);

    }

    function calculateDistrictRankings(district) {
      const allDistricts = Object.keys(nfhsData.districts);
      const rankings = {
        overall: { nfhs4: 0, nfhs5: 0 },
        categories: {},
        indicators: { nfhs4: {}, nfhs5: {} },
        comparison: { improved: 0, declined: 0, same: 0 }
      };

      // Calculate category-wise rankings
      Object.entries(categoriesData.categories).forEach(([catKey, catData]) => {
        rankings.categories[catKey] = { nfhs4: [], nfhs5: [] };
        
        catData.indicators.forEach(indicator => {
          const indName = typeof indicator === 'string' ? indicator : indicator.name;
          const indType = typeof indicator === 'object' ? indicator.indicator_type : 'Positive';
          
          // Calculate ranks for this indicator across all districts
          const nfhs4Ranks = calculateIndicatorRanks(indName, 'nfhs_4', indType);
          const nfhs5Ranks = calculateIndicatorRanks(indName, 'nfhs_5', indType);
          
          if (nfhs4Ranks[district]) rankings.categories[catKey].nfhs4.push(nfhs4Ranks[district]);
          if (nfhs5Ranks[district]) rankings.categories[catKey].nfhs5.push(nfhs5Ranks[district]);
          
          rankings.indicators.nfhs4[indName] = nfhs4Ranks[district] || null;
          rankings.indicators.nfhs5[indName] = nfhs5Ranks[district] || null;
        });
      });

      // Calculate median ranks for categories
      Object.keys(rankings.categories).forEach(catKey => {
        rankings.categories[catKey].nfhs4Median = calculateMedian(rankings.categories[catKey].nfhs4);
        rankings.categories[catKey].nfhs5Median = calculateMedian(rankings.categories[catKey].nfhs5);
      });

      // Calculate overall median ranks
      const allNfhs4Ranks = Object.values(rankings.indicators.nfhs4).filter(r => r !== null);
      const allNfhs5Ranks = Object.values(rankings.indicators.nfhs5).filter(r => r !== null);
      rankings.overall.nfhs4 = calculateMedian(allNfhs4Ranks);
      rankings.overall.nfhs5 = calculateMedian(allNfhs5Ranks);

      // Calculate comparison stats
      Object.keys(rankings.indicators.nfhs4).forEach(indicator => {
        const rank4 = rankings.indicators.nfhs4[indicator];
        const rank5 = rankings.indicators.nfhs5[indicator];
        
        if (rank4 && rank5) {
          if (rank5 < rank4) rankings.comparison.improved++;
          else if (rank5 > rank4) rankings.comparison.declined++;
          else rankings.comparison.same++;
        }
      });

      return rankings;
    }

    function calculateIndicatorRanks(indicator, survey, indicatorType) {
      const values = [];
      const districts = Object.keys(nfhsData.districts);
      
      districts.forEach(district => {
        const value = nfhsData.districts[district][survey] && nfhsData.districts[district][survey][indicator];
        if (value !== undefined && value !== null && value !== '') {
          values.push({ district, value: parseFloat(value) });
        }
      });

      // Sort based on indicator type
      if (indicatorType === 'Negative') {
        values.sort((a, b) => a.value - b.value); // Lower is better
      } else {
        values.sort((a, b) => b.value - a.value); // Higher is better
      }

      const ranks = {};
      values.forEach((item, index) => {
        ranks[item.district] = index + 1;
      });

      return ranks;
    }

    function calculateMedian(arr) {
      if (!arr.length) return null;
      const sorted = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
    }

    function getPerformanceLevel(rank) {
      if (rank <= 10) return 'good';
      if (rank <= 22) return 'average';
      return 'poor';
    }

    function getPerformanceLabel(rank) {
      if (rank <= 10) return 'Good Performer';
      if (rank <= 22) return 'Average Performer';
      return 'Needs Attention';
    }

    function getTrendIcon(rank4, rank5) {
      if (!rank4 || !rank5) return '→';
      if (rank5 < rank4) return '↑';
      if (rank5 > rank4) return '↓';
      return '→';
    }

    function updateDistrictInfo(district, rankings) {
      const container = document.getElementById('districtInfo');
      const overallRank = Math.round(rankings.overall.nfhs5 || rankings.overall.nfhs4 || 0);
      const level = getPerformanceLevel(overallRank);
      
      const iconName = level === 'good' ? 'trending_up' : level === 'average' ? 'trending_flat' : 'trending_down';
      const iconColor = level === 'good' ? '#059669' : level === 'average' ? '#b45309' : '#dc2626';
      const bgColor = level === 'good' ? '#dcfce7' : level === 'average' ? '#fbbf24' : '#fee2e2';
      const borderColor = level === 'good' ? '#059669' : level === 'average' ? '#b45309' : '#dc2626';
      
      container.innerHTML = `
        <div style="padding:6px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <div style="width:32px;height:32px;background:${bgColor};border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid ${borderColor}">
              <span class="material-icons" style="font-size:18px;color:${iconColor}">${iconName}</span>
            </div>
            <div>
              <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:2px">Overall Performance</div>
              <div style="font-size:9px;color:#6b7280;text-transform:uppercase;letter-spacing:0.3px">District Health Ranking</div>
            </div>
          </div>
          
          <div style="text-align:center;margin:12px 0">
            <div style="font-size:32px;font-weight:800;color:${iconColor};line-height:1">
              ${overallRank}<span style="font-size:16px;color:#6b7280;font-weight:500">/32</span>
            </div>
            <div style="font-size:10px;color:#6b7280;margin-top:2px;font-weight:600">MEDIAN RANK</div>
          </div>
          
          <div style="display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:6px;background:${bgColor};border:1px solid ${borderColor}">
            <span class="material-icons" style="font-size:12px;color:${iconColor}">${level === 'good' ? 'check_circle' : level === 'average' ? 'info' : 'warning'}</span>
            <span style="color:${iconColor};font-size:10px;font-weight:700;flex:1">${getPerformanceLabel(overallRank)}</span>
            <div style="font-size:8px;color:${iconColor};opacity:0.7;font-weight:600">${level === 'good' ? 'EXCELLENT' : level === 'average' ? 'MODERATE' : 'PRIORITY'}</div>
          </div>
        </div>
      `;
    }

    function updateOverallPerformance(rankings) {
      const container = document.getElementById('overallPerformance');
      const rank4 = Math.round(rankings.overall.nfhs4 || 0);
      const rank5 = Math.round(rankings.overall.nfhs5 || 0);
      const currentRank = rank5 || rank4;
      const level = getPerformanceLevel(currentRank);
      const trend = getTrendIcon(rank4, rank5);
      
      container.innerHTML = `
        <div class="performance-grid">
          <div class="performance-card ${level}">
            <div class="rank-label">Overall Median Rank</div>
            <div class="rank-number" style="color:${level === 'good' ? 'var(--success)' : level === 'average' ? 'var(--warning)' : 'var(--danger)'}">${currentRank}</div>
            <div class="performance-label">${getPerformanceLabel(currentRank)}</div>
            <div class="trend-indicator">
              <span style="font-size:18px">${trend}</span>
              <span>NFHS-4 to NFHS-5</span>
            </div>
          </div>
        </div>
      `;
    }

    function updateCategoryPerformance(rankings) {
      const container = document.getElementById('categoryPerformance');
      let html = '<div class="category-grid">';
      
      Object.entries(rankings.categories).forEach(([catKey, catData]) => {
        const rank5 = Math.round(catData.nfhs5Median || catData.nfhs4Median || 0);
        const level = getPerformanceLevel(rank5);
        
        html += `
          <div class="category-item">
            <div style="font-size:14px;font-weight:500">${catKey.replace(/_/g, ' ')}</div>
            <div class="category-rank">
              <span class="rank-badge ${level}">${rank5}/32</span>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function updateProgressChart(rankings) {
      const canvas = document.getElementById('progressChart');
      const placeholder = document.getElementById('chartPlaceholder');
      const legend = document.getElementById('progressLegend');
      const { improved, declined, same } = rankings.comparison;
      
      if (improved === 0 && declined === 0 && same === 0) {
        canvas.style.display = 'none';
        placeholder.style.display = 'block';
        legend.style.display = 'none';
        return;
      }
      
      canvas.style.display = 'block';
      placeholder.style.display = 'none';
      legend.style.display = 'block';
      
      if (progressChart) {
        progressChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Improved', 'Same', 'Declined'],
          datasets: [{
            data: [improved, same, declined],
            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
            borderColor: '#000000',
            borderWidth: 0.7,
            cutout: '60%'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.parsed + ' indicators';
                }
              }
            }
          }
        }
      });
    }

    function updateCategoryRankings(rankings) {
      const container = document.getElementById('categoryRankings');
      
      if (!rankings.categories || Object.keys(rankings.categories).length === 0) {
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">No data available</p>';
        return;
      }
      
      // Sort categories by performance level
      const categoriesArray = Object.entries(rankings.categories).map(([catKey, catData]) => {
        const nfhs4Rank = Math.round(catData.nfhs4Median || 0);
        const nfhs5Rank = Math.round(catData.nfhs5Median || 0);
        const currentRank = nfhs5Rank || nfhs4Rank;
        const level = getPerformanceLevel(currentRank);
        const trend = getTrendIcon(nfhs4Rank, nfhs5Rank);
        return { catKey, catData, nfhs4Rank, nfhs5Rank, currentRank, level, trend };
      });
      
      // Group by performance level
      const good = categoriesArray.filter(cat => cat.level === 'good').sort((a, b) => a.currentRank - b.currentRank);
      const average = categoriesArray.filter(cat => cat.level === 'average').sort((a, b) => a.currentRank - b.currentRank);
      const poor = categoriesArray.filter(cat => cat.level === 'poor').sort((a, b) => a.currentRank - b.currentRank);
      
      let html = '<div style="display:flex;flex-direction:column;gap:8px">';
      
      // Good performers
      if (good.length > 0) {
        html += '<div style="margin-bottom:8px">';
        html += '<div style="font-size:10px;color:#059669;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="material-icons" style="font-size:12px">trending_up</span>Strengths</div>';
        good.forEach(cat => {
          html += `<div class="category-item" data-category="${cat.catKey}" data-nfhs4="${cat.nfhs4Rank}" data-nfhs5="${cat.nfhs5Rank}" data-trend="${cat.trend}" style="padding:8px 10px;margin-bottom:4px;border-radius:6px;background:#dcfce7;border-left:3px solid #059669;cursor:pointer;transition:all 0.2s ease;font-size:13px;font-weight:600;color:#059669" onmouseover="this.style.background='#bbf7d0'" onmouseout="this.style.background='#dcfce7'" onclick="toggleCategoryDetails(this)">${cat.catKey.replace(/_/g, ' ')}</div>`;
        });
        html += '</div>';
      }
      
      // Average performers
      if (average.length > 0) {
        html += '<div style="margin-bottom:8px">';
        html += '<div style="font-size:10px;color:#b45309;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="material-icons" style="font-size:12px">trending_flat</span>Moderate</div>';
        average.forEach(cat => {
          html += `<div class="category-item" data-category="${cat.catKey}" data-nfhs4="${cat.nfhs4Rank}" data-nfhs5="${cat.nfhs5Rank}" data-trend="${cat.trend}" style="padding:8px 10px;margin-bottom:4px;border-radius:6px;background:#fbbf24;border-left:3px solid #b45309;cursor:pointer;transition:all 0.2s ease;font-size:13px;font-weight:600;color:#b45309" onmouseover="this.style.background='#fcd34d'" onmouseout="this.style.background='#fbbf24'" onclick="toggleCategoryDetails(this)">${cat.catKey.replace(/_/g, ' ')}</div>`;
        });
        html += '</div>';
      }
      
      // Poor performers
      if (poor.length > 0) {
        html += '<div style="margin-bottom:8px">';
        html += '<div style="font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="material-icons" style="font-size:12px">trending_down</span>Priority</div>';
        poor.forEach(cat => {
          html += `<div class="category-item" data-category="${cat.catKey}" data-nfhs4="${cat.nfhs4Rank}" data-nfhs5="${cat.nfhs5Rank}" data-trend="${cat.trend}" style="padding:8px 10px;margin-bottom:4px;border-radius:6px;background:#fee2e2;border-left:3px solid #dc2626;cursor:pointer;transition:all 0.2s ease;font-size:13px;font-weight:600;color:#dc2626" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'" onclick="toggleCategoryDetails(this)">${cat.catKey.replace(/_/g, ' ')}</div>`;
        });
        html += '</div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function toggleCategoryDetails(element) {
      const category = element.dataset.category;
      const nfhs4 = element.dataset.nfhs4;
      const nfhs5 = element.dataset.nfhs5;
      const trend = element.dataset.trend;
      
      // Check if details are already shown
      const existingDetails = element.nextElementSibling;
      if (existingDetails && existingDetails.classList.contains('category-details')) {
        existingDetails.remove();
        return;
      }
      
      // Remove any other open details
      document.querySelectorAll('.category-details').forEach(detail => detail.remove());
      
      // Create details element
      const details = document.createElement('div');
      details.className = 'category-details';
      details.style.cssText = 'background:rgba(255,255,255,0.9);padding:8px;margin:4px 0;border-radius:4px;border:1px solid #e6eefb;font-size:10px;color:#374151;animation:slideDown 0.2s ease';
      details.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px">
            <span>NFHS-4: <strong>${nfhs4 || 'N/A'}</strong></span>
            <span>NFHS-5: <strong>${nfhs5 || 'N/A'}</strong></span>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:12px">${trend}</span>
            <div style="background:var(--accent);color:white;padding:3px;border-radius:4px;cursor:pointer;transition:all 0.2s ease" onclick="showCategoryTable('${category}')" title="View detailed indicators">
              <span class="material-icons" style="font-size:12px">table_view</span>
            </div>
          </div>
        </div>
      `;
      
      element.parentNode.insertBefore(details, element.nextSibling);
    }
    
    function showCategoryTable(categoryKey) {
      if (!nfhsData || !categoriesData) return;
      
      const categoryData = categoriesData.categories[categoryKey];
      if (!categoryData) return;
      
      const indicators = categoryData.indicators.map(i => typeof i === 'string' ? i : i.name).filter(Boolean);
      
      // Get indicator data for current district
      const districtData = nfhsData.districts[currentDistrict];
      if (!districtData) return;
      
      const tableData = [];
      indicators.forEach(indicator => {
        const nfhs4Value = districtData.nfhs_4 && districtData.nfhs_4[indicator];
        const nfhs5Value = districtData.nfhs_5 && districtData.nfhs_5[indicator];
        
        if (nfhs4Value !== undefined || nfhs5Value !== undefined) {
          // Calculate ranks for this indicator
          const indicatorType = getIndicatorTypeFromCategories(indicator);
          const nfhs4Ranks = calculateIndicatorRanks(indicator, 'nfhs_4', indicatorType);
          const nfhs5Ranks = calculateIndicatorRanks(indicator, 'nfhs_5', indicatorType);
          
          const nfhs4Rank = nfhs4Ranks[currentDistrict] || 'N/A';
          const nfhs5Rank = nfhs5Ranks[currentDistrict] || 'N/A';
          const latestRank = nfhs5Rank !== 'N/A' ? nfhs5Rank : nfhs4Rank;
          
          tableData.push({
            indicator,
            nfhs4Value: nfhs4Value || 'N/A',
            nfhs5Value: nfhs5Value || 'N/A',
            nfhs4Rank,
            nfhs5Rank,
            latestRank,
            sortOrder: getSortOrder(latestRank)
          });
        }
      });
      
      // Create popup
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
      
      const modal = document.createElement('div');
      modal.style.cssText = 'background:white;border-radius:16px;padding:24px;width:85%;max-width:900px;height:80vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #f1f5f9;padding-bottom:16px;flex-shrink:0';
      header.innerHTML = `
        <div>
          <h3 style="margin:0;color:#1e293b;font-weight:700;font-size:18px">${categoryKey.replace(/_/g, ' ')} - Detailed Indicators</h3>
          <div style="margin:8px 0 0;color:#64748b;font-size:12px">${capitalizeWords(currentDistrict)} District • NFHS Data</div>
        </div>
        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:8px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(239,68,68,0.3)" onclick="this.parentElement.parentElement.parentElement.remove()">
          <span class="material-icons" style="font-size:18px">close</span>
        </div>
      `;
      
      const content = document.createElement('div');
      content.style.cssText = 'flex:1;overflow-y:auto;margin-top:8px';
      
      if (tableData.length === 0) {
        content.innerHTML = `
          <div style="text-align:center;padding:40px;color:var(--muted)">
            <span class="material-icons" style="font-size:48px;color:#e2e8f0;margin-bottom:16px">table_view</span>
            <div style="font-size:16px;font-weight:600;margin-bottom:8px">No Data Available</div>
            <div style="font-size:14px">No matching indicators found for this category in the selected district.</div>
          </div>
        `;
      } else {
        content.innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead>
              <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0">
                <th style="text-align:left;padding:12px 8px;font-weight:700;color:#374151">Indicator</th>
                <th style="text-align:center;padding:12px 8px;font-weight:700;color:#374151">NFHS-4 Value</th>
                <th style="text-align:center;padding:12px 8px;font-weight:700;color:#374151">NFHS-4 Rank</th>
                <th style="text-align:center;padding:12px 8px;font-weight:700;color:#374151">NFHS-5 Value</th>
                <th style="text-align:center;padding:12px 8px;font-weight:700;color:#374151">NFHS-5 Rank</th>
              </tr>
            </thead>
            <tbody>
              ${tableData.map((row, index) => {
                const latestRank = row.nfhs5Rank !== 'N/A' ? row.nfhs5Rank : row.nfhs4Rank;
                const rankColor = getRankColor(latestRank);
                const bgColor = getRowBackgroundColor(latestRank);
                const borderColor = getRowBorderColor(latestRank);
                
                return `
                <tr style="border-bottom:1px solid #f1f5f9;background:${bgColor};border-left:4px solid ${borderColor};transition:all 0.2s ease" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                  <td style="padding:10px 12px;font-weight:600;color:#1e293b">
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:8px;height:8px;border-radius:50%;background:${rankColor}"></div>
                      <span>${row.indicator}</span>
                    </div>
                  </td>
                  <td style="padding:10px 8px;text-align:center;color:#374151;font-weight:500">${row.nfhs4Value}</td>
                  <td style="padding:10px 8px;text-align:center">
                    <span style="background:${getRankBadgeColor(row.nfhs4Rank)};color:white;padding:2px 6px;border-radius:10px;font-size:11px;font-weight:700">${row.nfhs4Rank}</span>
                  </td>
                  <td style="padding:10px 8px;text-align:center;color:#374151;font-weight:500">${row.nfhs5Value}</td>
                  <td style="padding:10px 8px;text-align:center">
                    <span style="background:${getRankBadgeColor(row.nfhs5Rank)};color:white;padding:2px 6px;border-radius:10px;font-size:11px;font-weight:700">${row.nfhs5Rank}</span>
                  </td>
                </tr>
              `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
      
      modal.appendChild(header);
      modal.appendChild(content);
      popup.appendChild(modal);
      document.body.appendChild(popup);
      
      // Close on background click
      popup.onclick = (e) => { if(e.target === popup) popup.remove(); };
    }
    
    function getIndicatorTypeFromCategories(indicator) {
      for(const [catKey, catData] of Object.entries(categoriesData.categories)){
        for(const ind of catData.indicators){
          const indName = typeof ind === 'string' ? ind : ind.name;
          if(indName === indicator){
            return typeof ind === 'object' ? ind.indicator_type : 'Positive';
          }
        }
      }
      return 'Positive';
    }
    
    function getRankColor(rank) {
      if (rank === 'N/A') return '#6b7280';
      const numRank = parseInt(rank);
      if (numRank <= 10) return '#059669';
      if (numRank <= 22) return '#b45309';
      return '#dc2626';
    }
    
    function getRowBackgroundColor(rank) {
      if (rank === 'N/A') return '#fafbfc';
      const numRank = parseInt(rank);
      if (numRank <= 10) return 'rgba(5,150,105,0.03)';
      if (numRank <= 22) return 'rgba(180,83,9,0.03)';
      return 'rgba(220,38,38,0.03)';
    }
    
    function getRowBorderColor(rank) {
      if (rank === 'N/A') return '#e5e7eb';
      const numRank = parseInt(rank);
      if (numRank <= 10) return '#059669';
      if (numRank <= 22) return '#b45309';
      return '#dc2626';
    }
    
    function getRankBadgeColor(rank) {
      if (rank === 'N/A') return '#6b7280';
      const numRank = parseInt(rank);
      if (numRank <= 10) return '#059669';
      if (numRank <= 22) return '#b45309';
      return '#dc2626';
    }
    
    function getSortOrder(rank) {
      if (rank === 'N/A') return 4;
      const numRank = parseInt(rank);
      if (numRank <= 10) return 1; // Good - show first
      if (numRank <= 22) return 2; // Average - show second
      return 3; // Poor - show third
    }



    function getBestCategory(categories) {
      let best = null;
      Object.entries(categories).forEach(([catKey, catData]) => {
        const rank = Math.round(catData.nfhs5Median || catData.nfhs4Median || 32);
        if (!best || rank < best.rank) {
          best = { name: catKey.replace(/_/g, ' '), rank };
        }
      });
      return best;
    }

    function getWorstCategory(categories) {
      let worst = null;
      Object.entries(categories).forEach(([catKey, catData]) => {
        const rank = Math.round(catData.nfhs5Median || catData.nfhs4Median || 1);
        if (!worst || rank > worst.rank) {
          worst = { name: catKey.replace(/_/g, ' '), rank };
        }
      });
      return worst;
    }

    function getTopCategories(categories, count) {
      const cats = [];
      Object.entries(categories).forEach(([catKey, catData]) => {
        const rank = Math.round(catData.nfhs5Median || catData.nfhs4Median || 32);
        cats.push({ name: catKey.replace(/_/g, ' '), rank });
      });
      return cats.sort((a, b) => a.rank - b.rank).slice(0, count);
    }

    function getBottomCategories(categories, count) {
      const cats = [];
      Object.entries(categories).forEach(([catKey, catData]) => {
        const rank = Math.round(catData.nfhs5Median || catData.nfhs4Median || 1);
        cats.push({ name: catKey.replace(/_/g, ' '), rank });
      });
      return cats.sort((a, b) => b.rank - a.rank).slice(0, count);
    }

    function resetViews() {
      const containers = ['districtInfo', 'overallPerformance', 'categoryPerformance', 'categoryRankings'];
      containers.forEach(id => {
        document.getElementById(id).innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">Select a district to view data</p>';
      });
      
      // Reset chart
      if (progressChart) {
        progressChart.destroy();
        progressChart = null;
      }
      document.getElementById('progressChart').style.display = 'none';
      document.getElementById('chartPlaceholder').style.display = 'block';
      document.getElementById('progressLegend').style.display = 'none';
    }

    function capitalizeWords(str) {
      return str.split(/[_\s]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function toggleMenu() {
      const menuItems = document.getElementById('menuItems');
      const menuButton = document.getElementById('menuButton');
      
      if (menuOpen) {
        menuItems.style.display = 'none';
        menuButton.style.transform = 'rotate(0deg)';
        menuOpen = false;
      } else {
        menuItems.style.display = 'flex';
        menuButton.style.transform = 'rotate(90deg)';
        menuOpen = true;
      }
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('hamburgerMenu');
      if (!menu.contains(e.target) && menuOpen) {
        toggleMenu();
      }
    });
  </script>
</body>
</html>